window.Rubix=window.Rubix||{};
Rubix=function(a,c){this.chart_counter=0;this.master_id=this.uid("master_id");this.data_stack={};this.chart_stack={};this.area_stack_data_stack=[];this.column_stack_data_stack=[];this.root_elem=$(a);this.root_elem.css("position","relative");this.root_elem.addClass("rubix-main-chart");this.root_elem.append('<div class="rubix-tooltip"></div>');this.root_elem.append('<div class="rubix-title"></div>');this.root_elem.append('<div class="rubix-subtitle"></div>');this.root_elem.append('<div class="rubix-chart"></div>');this.root_elem.append('<div class="rubix-legend"></div>');
var b=c.height||150;this.root_elem.width(c.width||"100%").height(b);this.elem=this.root_elem.find(".rubix-chart");c.tooltip=c.tooltip||{};this.tooltip=this.root_elem.find(".rubix-tooltip");this.tooltip.hide();this.tooltip.html("");this.tooltip.css({"font-family":'Lato, "Lucida Grande", Arial, Helvetica, sans-serif',"font-size":"12px",position:"absolute",background:"white",color:"#89949B",padding:"10px","max-width":150,"min-width":100,border:"2px solid "+(c.tooltip.color?c.tooltip.color:"#ccc"),"pointer-events":"none",
opacity:.95,"border-radius":"5px","box-shadow":"0px 2px 2px rgba(0,0,0,0.1)","z-index":100,"user-select":"none",cursor:"default"});c.legend=c.legend||{};this.legend=this.root_elem.find(".rubix-legend");this.legend.css({"font-family":"'Lucida Grande', Arial, Helvetica, sans-serif","text-align":"center","margin-top":c.legend.top||"-10px","margin-bottom":c.legend.bottom||"5px","user-select":"none",display:c.hideLegend?"none":"block"});this.title=this.root_elem.find(".rubix-title");this.subtitle=this.root_elem.find(".rubix-subtitle");
this.title.css({"font-family":"'Lucida Grande', Arial, Helvetica, sans-serif","text-align":"center","user-select":"none","font-weight":"bold","font-size":"16px",color:"steelblue","margin-top":"10px",cursor:"default"});this.subtitle.css({"font-family":"'Lucida Grande', Arial, Helvetica, sans-serif","text-align":"center","user-select":"none","font-size":"10px",color:"steelblue","margin-top":"10px",cursor:"default",opacity:.8});var d=this;this.tooltip.on({mouseover:function(a){d3.select(d.elem.find(".overlay").get(0)).node().__onmousemove(a)},
mousemove:function(a){d3.select(d.elem.find(".overlay").get(0)).node().__onmousemove(a)},mouseout:function(a){$(this).hide()}});this.elem.css({width:"100%",height:parseInt(this.root_elem.get(0).style.height),"user-select":"none",overflow:"hidden",cursor:"default"});this.root_elem.css("height","100%");this.opts=c||{};this.data={};this.charts={};this.extent=[];this.extent_coordinates=[];this.is_touch_device="ontouchstart"in document.documentElement;this.d3_eventSource=function(){for(var a=d3.event,
b;b=a.sourceEvent;)a=b;return a};this.custom_interpolations={sankey:function(a){for(var b=a[0][0],c=a[0][1],d,n,k=[b,",",c],l=0,m=a.length;++l<m;)d=a[l][0],n=a[l][1],b=(b+d)/2,k.push("C",b,",",c," ",b,",",n," ",d,",",n),b=d,c=n;return k.join("")}};this.setup()};Rubix.prototype.setup=function(){this._setupOpts();this._setupOnce();this._setupRedraw();this.draw()};Rubix.prototype.draw=function(){this._draw($(window).width(),$(window).height())};
Rubix.prototype.uid=function(a){return"rubix-"+a+"-"+Math.floor(2147483648*Math.random()).toString(36)};
Rubix.prototype._setupOpts=function(){this.opts.margin=this.opts.margin||{};this.margin={top:0<=this.opts.margin.top?this.opts.margin.top:30,left:0<=this.opts.margin.left?this.opts.margin.left:30,right:0<=this.opts.margin.right?this.opts.margin.right:30,bottom:0<=this.opts.margin.bottom?this.opts.margin.bottom:30};this.opts.invertAxes=this.opts.invertAxes||!1;this.opts.axis=this.opts.axis||{};this.opts.axis.x=this.opts.axis.x||{};this.opts.axis.y=this.opts.axis.y||{};this.axis={x:{type:this.opts.axis.x.type||
"linear",range:this.opts.axis.x.range||"",tickCount:this.opts.axis.x.tickCount||void 0,tickFormat:this.opts.axis.x.tickFormat||"",label:this.opts.axis.x.label||""},y:{type:this.opts.axis.y.type||"linear",range:this.opts.axis.y.range||"",tickCount:this.opts.axis.y.tickCount||void 0,tickFormat:this.opts.axis.y.tickFormat||"",label:this.opts.axis.y.label||""}};this.axis.x.label.length&&(this.opts.invertAxes?this.margin.left+=15:this.margin.bottom+=15);this.axis.y.label.length&&(this.opts.invertAxes?
this.margin.bottom+=15:this.margin.left+=15);this.margin.defaultLeft=this.margin.left;this.opts.tooltip=this.opts.tooltip||{};this.opts.tooltip.format=this.opts.tooltip.format||{};this.tooltipFormatter={format:{x:this.opts.tooltip.format.x||"",y:this.opts.tooltip.format.y||""}};if(this.opts.invertAxes){var a=this.axis.x;this.axis.x=this.axis.y;this.axis.y=a;a=this.tooltipFormatter.format.x;this.tooltipFormatter.format.x=this.tooltipFormatter.format.y;this.tooltipFormatter.format.y=a}0!==this.opts.animationSpeed&&
(this.animationSpeed=this.opts.animationSpeed||750);this.opts.interval=this.opts.start_interval||0;this.stacked=this.opts.stacked||!1;this.grouped=this.opts.grouped||!1;this.offset=this.opts.offset||"zero";this.order=this.opts.order||"default";this.show_markers=this.opts.show_markers||!1;this.resize=this.opts.resize||"debounced";this.interpolate=this.opts.interpolate||"linear";switch(this.interpolate){case "sankey":this.interpolate=this.custom_interpolations[this.interpolate]}this.master_detail=this.opts.master_detail||
!1;this.master_detail_height=this.opts.master_detail_height||50;this.master_detail&&(this.master_detail_margin_bottom=this.margin.bottom,this.margin.bottom=2*this.margin.bottom+this.master_detail_height);this.opts.title=this.opts.title||"";this.opts.subtitle=this.opts.subtitle||"";this.title.html(this.opts.title);this.subtitle.html(this.opts.subtitle);(this.opts.title.length||this.opts.subtitle.length)&&this.elem.css("margin-top","-20px");this.opts.title.length?this.title.show():this.title.hide();
this.opts.subtitle.length?this.subtitle.show():this.subtitle.hide()};
Rubix.prototype._setupOnce=function(){this.area_stack_data=[];this.area_stack=d3.layout.stack();this.area_stack.offset(this.offset);this.area_stack.order(this.order);this.area_stack.values(function(a){return a.values});this.area_stack.x(function(a){return a.x});this.area_stack.y(function(a){return a.y});this.area_stack.out(function(a,c,b){a.y0=c;a.y_new=b});this.column_stack_data=[];this.column_stack=d3.layout.stack();this.column_stack.offset("zero");this.column_stack.order("default");this.column_stack.values(function(a){return a.values});
this.column_stack.x(function(a){return a.x});this.column_stack.y(function(a){return a.y});this.column_stack.out(function(a,c,b){a.y0=c;a.y_new=b})};
Rubix.prototype._setupAxis=function(a){switch(this.axis.x.type){case "linear":this.x=d3.scale.linear();this.x.tickFormat(d3.format(this.axis.x.tickFormat));var c=[0,this.width],b=[0,this.width];this.master_detail&&(this.x2=d3.scale.linear());"round"===this.axis.x.range?(this.x.rangeRound(c),this.master_detail&&this.x2.rangeRound(b)):(this.x.range(c),this.master_detail&&this.x2.range(b));break;case "ordinal":this.x=d3.scale.ordinal();c=[0,this.width];b=[0,this.width];if(this.master_detail)throw this.canvas.select(".noData").text("Master-Detail chart only for quantitative scales."),
Error("Master-Detail chart only for quantitative scales.");"round"===this.axis.x.range?this.x.rangeRoundBands(c):"column"==this.axis.x.range||"bar"==this.axis.x.range?this.x.rangeRoundBands(c,.35):(this.x.rangePoints(c),this.master_detail&&this.x2.rangePoints(c));break;case "datetime":this.x=d3.time.scale();this.x.ticks(d3.time.year,50);this.x.tickFormat(d3.format(this.axis.x.tickFormat));c=[0,this.width];b=[0,this.width];this.master_detail&&(this.x2=d3.time.scale());"round"===this.axis.x.range?(this.x.rangeRound(c),
this.master_detail&&this.x2.rangeRound(b)):(this.x.range(c),this.master_detail&&this.x2.range(b));break;default:throw Error("Unknown Scale for X Axis: "+this.axis.x.type);}switch(this.axis.y.type){case "linear":this.y=d3.scale.linear();this.y.clamp(!0);this.y.tickFormat(d3.format(this.axis.y.tickFormat));c=[this.height,0];b=[this.master_detail_height,0];this.master_detail&&(this.y2=d3.scale.linear(),this.y2.clamp(!0));"round"===this.axis.y.range?(this.y.rangeRound(c),this.master_detail&&this.y2.rangeRound(b)):
(this.y.range(c),this.master_detail&&this.y2.range(b));break;case "ordinal":this.y=d3.scale.ordinal();c=[this.height,0];b=[this.master_detail_height,0];this.master_detail&&(this.y2=d3.scale.ordinal());"round"===this.axis.y.range?(this.y.rangeRoundBands(c),this.master_detail&&this.y2.rangeRoundBands(b)):"column"==this.axis.y.range||"bar"==this.axis.y.range?this.y.rangeRoundBands(c,.35):(this.y.rangePoints(c),this.master_detail&&this.y2.rangePoints(b));break;case "datetime":this.y=d3.time.scale();this.y.tickFormat(d3.format(this.axis.y.tickFormat));
this.y.clamp(!0);c=[this.height,0];b=[this.master_detail_height,0];this.master_detail&&(this.y2=d3.time.scale(),this.y2.clamp(!0));"round"===this.axis.y.range?(this.y.rangeRound(c),this.master_detail&&this.y2.rangeRound(b)):(this.y.range(c),this.master_detail&&this.y2.range(b));break;default:throw Error("Unknown Scale for X Axis: "+this.axis.y.type);}this.fontSize=10;c=Math.floor(this.height/(this.fontSize+3)/2);this.xAxis=d3.svg.axis();this.xAxis.scale(this.x).orient("bottom");this.master_detail&&
(this.xAxis2=d3.svg.axis(),this.xAxis2.scale(this.x2).orient("bottom"));"round"!==this.axis.x.range||"linear"!==this.axis.x.type&&"datetime"!==this.axis.x.type||("linear"===this.axis.x.type?this.xAxis.tickFormat(d3.format(this.axis.x.tickFormat)):"datetime"===this.axis.x.type&&this.xAxis.tickFormat(d3.time.format(this.axis.x.tickFormat)),this.master_detail&&("linear"===this.axis.x.type?this.xAxis2.tickFormat(d3.format(this.axis.x.tickFormat)):this.xAxis2.tickFormat(d3.time.format(this.axis.x.tickFormat))));
this.axis.x.tickFormat&&("linear"===this.axis.x.type?this.xAxis.tickFormat(d3.format(this.axis.x.tickFormat)):"datetime"===this.axis.x.type&&this.xAxis.tickFormat(d3.time.format(this.axis.x.tickFormat)),this.master_detail&&("linear"===this.axis.x.type?this.xAxis2.tickFormat(d3.format(this.axis.x.tickFormat)):this.xAxis2.tickFormat(d3.time.format(this.axis.x.tickFormat))));this.xGrid=d3.svg.axis();this.xGrid.scale(this.x).orient("bottom").ticks(5).tickSize(-this.height,0,0).tickFormat("");this.master_detail&&
(this.xGrid2=d3.svg.axis(),this.xGrid2.scale(this.x2).orient("bottom").ticks(5).tickSize(-this.master_detail_height,0,0).tickFormat(""));this.yAxis=d3.svg.axis();this.yAxis.scale(this.y).orient("left");this.yAxis.ticks(c);"round"!==this.axis.y.range||"linear"!==this.axis.y.type&&"datetime"!==this.axis.y.type||("linear"===this.axis.y.type?this.yAxis.tickFormat(d3.format(this.axis.y.tickFormat)):"datetime"===this.axis.y.type&&this.yAxis.tickFormat(d3.time.format(this.axis.y.tickFormat)));this.axis.y.tickFormat&&
("linear"===this.axis.y.type?this.yAxis.tickFormat(d3.format(this.axis.y.tickFormat)):"datetime"===this.axis.y.type&&this.yAxis.tickFormat(d3.time.format(this.axis.y.tickFormat)));this.yGrid=d3.svg.axis();this.yGrid.scale(this.y).orient("left").ticks(5).tickSize(-this.width,0,0).tickFormat("");this.xAxisGroup=this.axis_group.append("g");this.xAxisGroup.attr("class","x axis");this.xAxisGroup.attr("transform","translate(0, "+this.height+")");this.xAxisGroup.call(this.xAxis);this.xAxisGroup.select("path").style("fill",
"none").style("stroke","silver").style("shape-rendering","crispEdges");this.xAxisGroup.selectAll("line").attr("fill","none").attr("stroke","silver").style("shape-rendering","crispEdges");this.master_detail&&(this.xAxisGroup2=this.md_root.append("g"),this.xAxisGroup2.attr("class","x axis"),this.xAxisGroup2.attr("transform","translate(0, "+this.master_detail_height+")"),this.xAxisGroup2.call(this.xAxis2),this.xAxisGroup2.select("path").style("fill","none").style("stroke","silver").style("shape-rendering",
"crispEdges"),this.xAxisGroup2.select("line").style("fill","none").style("stroke","silver").style("shape-rendering","crispEdges"),this.xAxisGroup2.selectAll("line").attr("fill","none").attr("stroke","silver").style("shape-rendering","crispEdges"));this.yAxisGroup=this.axis_group.append("g");this.yAxisGroup.attr("class","y axis");this.yAxisGroup.call(this.yAxis);this.yAxisGroup.select("path").style("fill","none").style("stroke","silver").style("shape-rendering","crispEdges");this.yAxisGroup.selectAll("line").attr("fill",
"none").attr("stroke","silver").style("shape-rendering","crispEdges");this.xGridGroup=this.grid_group.append("g");this.xGridGroup.attr("class","x grid");this.xGridGroup.attr("transform","translate(0,"+this.height+")");this.xGridGroup.call(this.xGrid);this.xGridGroup.selectAll("path").style("stroke-width",0);this.xGridGroup.selectAll(".tick").style("stroke","lightgray").style("opacity",.7);this.master_detail&&(this.xGridGroup2=this.md_root.select(".md-grid").append("g"),this.xGridGroup2.attr("class",
"x grid"),this.xGridGroup2.attr("transform","translate(0,"+this.master_detail_height+")"),this.xGridGroup2.call(this.xGrid2),this.xGridGroup2.selectAll("path").style("stroke-width",0),this.xGridGroup2.selectAll(".tick").style("stroke","lightgray").style("opacity",.7));this.yGridGroup=this.grid_group.append("g");this.yGridGroup.attr("class","y grid");this.yGridGroup.call(this.yGrid);this.yGridGroup.selectAll("path").style("stroke-width",0);this.yGridGroup.selectAll(".tick").style("stroke","lightgray").style("opacity",
.7);this.resetAxis(a);if(this.master_detail){if("ordinal"===this.axis.x.type)throw this.canvas.select(".noData").text("Master-Detail chart only for quantitative scales."),Error("Master-Detail chart only for quantitative scales.");this.brush=d3.svg.brush();this.brush.x(this.x2);var d=this;if("datetime"===this.axis.x.type)this.brush.on("brushend",function(){var a=(d.is_touch_device?d3.touches(this,d.d3_eventSource().changedTouches)[0]:d3.mouse(this))[0];if(d.brush.empty()){var b=d.x2(+new Date(d.extent[0])),
c=d.x2(+new Date(d.extent[1])),a=b-a,h=[];0>a?(b+=Math.abs(a),c+=Math.abs(a),a=d.x2(+new Date(d.x2.domain()[1])),c>a?(b-=c-a,c=a,h=[d.x2.invert(b),d.x2.invert(c)]):(a=Math.abs(b-c),h=[d.x2.invert(b-a/2),d.x2.invert(c-a/2)])):(b-=Math.abs(a),c-=Math.abs(a),a=Math.abs(b-c),b-=a/2,c-=a/2,a=d.x2(+new Date(d.x2.domain()[0])),b<a&&(c+=a-b,b=a),h=[d.x2.invert(b),d.x2.invert(c)]);d.extent=h;d.brush.extent(d.extent);d.brush_path.call(d.brush);d._brush()}});else this.brush.on("brushend",function(){var a=d.is_touch_device?
d3.touches(this,d.d3_eventSource().changedTouches)[0]:d3.mouse(this),b=d.x2.invert(a[0]);if(d.brush.empty()){var c=d.extent[0],a=d.extent[1],b=c-b,h=[];0>b?(c+=Math.abs(b),a+=Math.abs(b),b=d.x2.domain()[1],a>b?(c-=a-b,h=[c,b]):(b=Math.abs(c-a),h=[c-b/2,a-b/2])):(c-=Math.abs(b),a-=Math.abs(b),b=Math.abs(c-a),c-=b/2,a-=b/2,b=d.x2.domain()[0],c<b&&(a+=b-c,c=b),h=[c,a]);d.extent=h;d.brush.extent(d.extent);d.brush_path.call(d.brush);d._brush()}});this.brush.on("brush",function(){var a=d.d3_eventSource().type;
if("mousemove"===a||"touchmove"===a)$(window).trigger("rubix.sidebar.off"),d._brush(!0,"root")});this.extent.length&&(this.brush.extent(this.extent),this.extent_coordinates.length||(this.extent_coordinates="datetime"===this.axis.x.type||"datetime"===this.axis.y.type?[this.x2(+new Date(this.extent[0])),this.x2(+new Date(this.extent[1]))]:[this.x2(this.extent[0]),this.x2(this.extent[1])]),this._brush())}};
Rubix.prototype._setupSeries=function(){this.grid_group=this.root.append("g").attr("class","grid_group");this.axis_group=this.root.append("g").attr("class","axis_group");this.opts.hideAxis&&(this.grid_group.style("display","none"),this.axis_group.style("display","none"));this.root_cb_series=this.root.append("g").attr("class","cb_series");this.root_stacked_area_series=this.root.append("g").attr("class","stacked_area_series");this.root_area_series=this.root.append("g").attr("class","area_series");this.root_line_series=
this.root.append("g").attr("class","line_series");this.focus_line_group=this.root.append("g").attr("class","focus_line_group");this.symbols_group=this.root.append("g").attr("class","symbols");this.focus_group=this.root.append("g").attr("class","focus_group")};
Rubix.prototype.resetExtent=function(){if(this.brush.extent().length){var a=this.extent_coordinates[0],c=this.extent_coordinates[1];this.extent="datetime"===this.axis.x.type||"datetime"===this.axis.y.type?[this.x2.invert(+new Date(a)),this.x2.invert(+new Date(c))]:[this.x2.invert(a),this.x2.invert(c)];this.brush.extent(this.extent);this._brush_nochange()}};Rubix.prototype._brush_nochange=function(){this.x.domain(this.extent);this.callAxis();for(var a in this.charts)this.charts[a].noRedraw(this)};
Rubix.prototype._brush=function(a,c){var b=this.brush.empty()?this.x2.domain():this.brush.extent();"datetime"===this.axis.x.type||"datetime"===this.axis.y.type?(this.extent=b,a&&"root"===c&&(this.extent_coordinates=[this.x2(+new Date(this.extent[0])),this.x2(+new Date(this.extent[1]))])):(this.extent=b,a&&"root"===c&&(this.extent_coordinates=[this.x2(this.extent[0]),this.x2(this.extent[1])]));this._brush_nochange()};
Rubix.prototype._setupOrdinalAxis=function(a){var c={},b={},d=[],e=[],f,g;this.crosshair_data=[];_o_data=[];var h={},n={};if("ordinal"===this.axis.x.type||"ordinal"===this.axis.y.type){for(var k in this.data){g=this.data[k];var l=this.charts[k];for(f=0;f<g.length;f++){var m=g[f].x,q=0;if(this.stacked){g[f].hasOwnProperty("y0")&&(q=g[f].y0);var p=g[f].hasOwnProperty("y_new")?this.grouped&&"column_series"===l.type?g[f].y_new:g[f].y_new+q:g[f].y}else p=g[f].y;e.push(p);c.hasOwnProperty(m)||(c[m]=[]);
c[m].push(p);a&&(b.hasOwnProperty(p)||(b[p]=[]),b[p].push(m));h.hasOwnProperty(m)||(h[m]={});h[m][k]=p;n.hasOwnProperty(m)||(n[m]={});n[m][k]={y0:q}}}for(var r in c)d.push(r);if(a)for(r in b)_o_data.push(r);this.stacked?(f=d3.min(e,function(a){return isNaN(a)?0:a}),f=[0>f?f:0,d3.max(e,function(a){return isNaN(a)?0:a})]):f=d3.extent(e);e=f[0];c=f[1];if(this.opts.invertAxes){if(this.axis.y.tickFormat.length){for(f=0;f<d.length;f++)d[f]=+d[f];d.sort(function(a,b){return a>b?1:a===b?0:-1})}if(a){if(this.axis.x.tickFormat.length){for(f=
0;f<_o_data.length;f++)_o_data[f]=+_o_data[f];_o_data.sort(function(a,b){return a>b?1:a===b?0:-1})}this.x.domain(_o_data);this.y.domain(d.reverse());this.master_detail&&(this.x2.domain(_o_data),this.y2.domain(d))}else this.x.domain([e,c]),this.y.domain(d.reverse()),this.master_detail&&(this.x2.domain([e,c]),this.y2.domain(d))}else{if(this.axis.x.tickFormat.length){for(f=0;f<d.length;f++)d[f]=+d[f];d.sort(function(a,b){return a>b?1:a===b?0:-1})}if(a){if(this.axis.y.tickFormat.length){for(f=0;f<_o_data.length;f++)_o_data[f]=
+_o_data[f];_o_data.sort(function(a,b){return a>b?1:a===b?0:-1})}this.x.domain(d);this.y.domain(_o_data);this.master_detail&&(this.x2.domain(d),this.y2.domain(_o_data))}else this.x.domain(d),this.y.domain([e,c]),this.master_detail&&(this.x2.domain(d),this.y2.domain([e,c]))}for(m in h)a=this.opts.invertAxes?this.y(m):this.x(m),this.crosshair_data.push({x:+a,y:h[m],others:n[m]});this.crosshair_data.sort(function(a,b){return a.x>b.x?1:a.x===b.x?0:-1})}};
Rubix.prototype._setupLinearAxis=function(){var a=null,c=null,b=null,d=null,e,f,g;this.crosshair_data=[];var h={},n={},k;for(k in this.data)for(e=this.data[k],f=d3.extent(e,function(a){return a.x}),this.stacked?(g=d3.min(e,function(a){var b=a.y0+a.y_new;return isNaN(b)?a.y?a.y:0:b}),g=0>g?g:0,g=[g,d3.max(e,function(a){var b=a.y0+a.y_new;return isNaN(b)?a.y?a.y:0:b})]):g=d3.extent(e,function(a){return a.y}),null===a?(a=f[0],c=f[1]):(a>=f[0]&&(a=f[0]),c<=f[1]&&(c=f[1])),null===b?(b=g[0],d=g[1]):(b>=
g[0]&&(b=g[0]),d<=g[1]&&(d=g[1])),f=0;f<e.length;f++){var l=e[f].x;g=0;if(this.stacked){e[f].hasOwnProperty("y0")&&(g=e[f].y0);var m=e[f].hasOwnProperty("y_new")?e[f].y_new+g:e[f].y}else m=e[f].y;h.hasOwnProperty(l)||(h[l]={});h[l][k]=m;n.hasOwnProperty(l)||(n[l]={});n[l][k]={y0:g}}this.opts.invertAxes?(this.x.domain([b,d]),this.y.domain([c,a]),this.master_detail&&(this.x2.domain([b,d]),this.y2.domain([c,a]))):(this.x.domain([a,c]),this.y.domain([b,d]),this.master_detail&&(this.x2.domain([a,c]),this.y2.domain([b,
d])));for(l in h)this.crosshair_data.push({x:+l,y:h[l],others:n[l]});this.crosshair_data.sort(function(a,b){return a.x>b.x?1:a.x===b.x?0:-1})};
Rubix.prototype.resetAxis=function(a){"linear"===this.axis.x.type&&"linear"===this.axis.y.type?this._setupLinearAxis():"datetime"===this.axis.x.type&&"linear"===this.axis.y.type||"linear"===this.axis.x.type&&"datetime"===this.axis.y.type?this._setupLinearAxis():"ordinal"===this.axis.x.type&&"ordinal"===this.axis.y.type?this._setupOrdinalAxis(!0):"ordinal"!==this.axis.x.type&&"ordinal"!==this.axis.y.type||this._setupOrdinalAxis();this.callAxis(a)};
Rubix.prototype.callAxis=function(a){if(a){if(a=this.root.transition().duration(this.animationSpeed),this.master_detail)var c=this.md_root.transition().duration(this.animationSpeed)}else a=this.root,this.master_detail&&(c=this.md_root);if(this.hasData){if("ordinal"===this.axis.x.type){var b=this.x.domain();if(b.length>this.axis.x.tickCount){var d=this,e=d3.range(b.length).map(function(a){return 0===a%d.axis.x.tickCount?b[a]:""});this.xAxis.tickValues(e)}}else this.axis.x.tickCount&&(this.xAxis.ticks(this.axis.x.tickCount),
this.master_detail&&this.xAxis2.ticks(this.axis.x.tickCount));"ordinal"===this.axis.y.type||"linear"===this.axis.x.type||"datetime"===this.axis.x.type?(b=this.y.domain(),b.length>this.axis.y.tickCount&&(d=this,e=d3.range(b.length).map(function(a){return 0===a%d.axis.y.tickCount?b[a]:""}),this.yAxis.tickValues(e))):this.axis.y.tickCount&&this.yAxis.ticks(this.axis.y.tickCount);this.canvas.select(".noData").style("display","none");a.selectAll(".x.axis").style("display",null).call(this.xAxis);a.selectAll(".y.axis").style("display",
null).call(this.yAxis);a.selectAll(".x.grid").style("display",null).call(this.xGrid);a.selectAll(".y.grid").style("display",null).call(this.yGrid);this.xAxisGroup.selectAll("line").attr("fill","none").attr("stroke","silver").style("shape-rendering","crispEdges");this.yAxisGroup.selectAll("line").attr("fill","none").attr("stroke","silver").style("shape-rendering","crispEdges");this.xGridGroup.selectAll("path").style("stroke-width",0);this.xGridGroup.selectAll(".tick").style("stroke","lightgray").style("opacity",
.7);this.yGridGroup.selectAll("path").style("stroke-width",0);this.yGridGroup.selectAll(".tick").style("stroke","lightgray").style("opacity",.7);this.xAxisGroup.selectAll("text").style("font",this.fontSize+1+'px "Lucida Grande", "Lucida Sans Unicode", Verdana, Arial, Helvetica, sans-serif').style("direction","ltr").style("fill","#E9E9E9").style("color","#E9E9E9").style("font-style","").style("font-variant","").style("font-weight","").style("line-height","");this.yAxisGroup.selectAll("text").style("font",
this.fontSize+1+'px "Lucida Grande", "Lucida Sans Unicode", Verdana, Arial, Helvetica, sans-serif').style("direction","ltr").style("fill","#E9E9E9").style("color","#E9E9E9").style("font-style","").style("font-variant","").style("font-weight","").style("line-height","")}else this.canvas.select(".noData").style("display",null),a.selectAll(".x.axis").style("display","none"),a.selectAll(".y.axis").style("display","none"),a.selectAll(".x.grid").style("display","none"),a.selectAll(".y.grid").style("display",
"none");this.master_detail&&(this.hasData?(this.canvas.select(".noData").style("display","none"),c.selectAll(".x.axis").style("display",null).call(this.xAxis2),c.selectAll(".x.grid").style("display",null).call(this.xGrid2),this.xAxisGroup2&&(this.xAxisGroup2.selectAll("line").attr("fill","none").attr("stroke","silver").style("shape-rendering","crispEdges"),this.xGridGroup2.selectAll("path").style("stroke-width",0),this.xGridGroup2.selectAll(".tick").style("stroke","lightgray").style("opacity",.7),
this.xAxisGroup2.selectAll("text").style("font",this.fontSize+1+'px "Lucida Grande", "Lucida Sans Unicode", Verdana, Arial, Helvetica, sans-serif').style("direction","ltr").style("fill","#E9E9E9").style("color","#E9E9E9").style("font-style","").style("font-variant","").style("font-weight","").style("line-height","")),this.yAxisGroup2&&this.yAxisGroup2.selectAll("text").style("font",this.fontSize+1+'px "Lucida Grande", "Lucida Sans Unicode", Verdana, Arial, Helvetica, sans-serif').style("direction",
"ltr").style("fill","#E9E9E9").style("color","#E9E9E9").style("font-style","").style("font-variant","").style("font-weight","").style("line-height","")):(this.canvas.select(".noData").style("display",null),c.selectAll(".x.axis").style("display","none"),c.selectAll(".y.axis").style("display","none"),c.selectAll(".x.grid").style("display","none"),c.selectAll(".y.grid").style("display","none")))};
Rubix.prototype._setupRedraw=function(){var a=this;$(window).bind("orientationchange."+this.master_id,function(){a.draw()});$(window).bind("rubix.redraw."+this.master_id,function(){a.draw()});switch(this.resize){case "always":$(window).data("resize","resize");$(window).bind("resize.rubix."+this.master_id,function(){a.draw()});break;case "debounced":$(window).data("resize","debouncedresize");$(window).bind("debouncedresize.rubix."+this.master_id,function(){a.draw()});break;case "throttled":$(window).data("resize",
"throttledresize");$(window).bind("throttledresize.rubix."+this.master_id,function(){a.draw()});break;default:throw Error("Unknown resize type!");}};Rubix.prototype._draw=function(a,c){this._cleanElement();this._setSize();this._setupCanvas();this._setupRoot();this._setupSeries();this._setupAxis();for(var b in this.charts)this.charts[b].redraw(this)};Rubix.prototype._cleanElement=function(){this.elem.children().remove()};
Rubix.prototype._setSize=function(){this.outerWidth=this.elem.width();this.outerHeight=this.elem.height();this.width=this.outerWidth-this.margin.left-this.margin.right;this.height=this.outerHeight-this.margin.top-this.margin.bottom;this.opts.hideAxis&&(this.margin.left=0,this.margin.right=0,this.width=this.outerWidth)};
Rubix.prototype._setupCanvas=function(){this.canvas=d3.select(this.elem.get(0)).append("svg");this.canvas.attr("width",this.outerWidth);this.canvas.attr("height",this.outerHeight);this.canvas.append("desc").text("Powered by Rubix");this.defs=this.canvas.append("defs");this.defs.append("clipPath").attr("id",this.master_id+"-clip").append("rect").attr("width",this.width).attr("height",this.height+20).attr("transform","translate(0, -20)")};
Rubix.prototype._setupRoot=function(){this.root=this.canvas.append("g");this.root.attr("width",this.width);this.root.attr("height",this.height);this.opts.hideAxis?this.root.attr("transform","translate(0,"+this.margin.top+")"):this.root.attr("transform","translate("+this.margin.left+","+this.margin.top+")");this.hasData?this.canvas.select(".noData").style("display","none"):this.canvas.append("text").attr("class","noData").attr("font-size","30px").attr("text-anchor","middle").attr("transform","translate("+
this.outerWidth/2+","+this.outerHeight/2+")").attr("font-family",'Lato, "Lucida Grande", Arial, Helvetica, sans-serif').text("No Data");if(this.master_detail){this.md_root=this.canvas.append("g");this.md_root.attr("width",this.width);this.md_root.attr("height",this.master_detail_height);this.opts.hideAxis||this.md_root.attr("transform","translate("+this.margin.left+","+(this.margin.top+this.height+this.master_detail_margin_bottom)+")");var a=this.md_root.append("rect");a.attr("width",this.md_root.attr("width"));
a.attr("height",this.md_root.attr("height"));a.attr("fill","none");a.attr("stroke","silver");a.attr("shape-rendering","crispEdges");this.md_root.append("g").attr("class","md-grid");this.md_root.append("g").attr("class","md-layers").attr("clip-path","url(#"+this.master_id+"-clip)");this.defs.append("clipPath").attr("id",this.master_id+"-clip-symbols").append("rect").attr("width",this.width).attr("height",this.height+20).attr("transform","translate(0, -10)");this.defs.append("clipPath").attr("id",this.master_id+
"-clip-brush").append("rect").attr("width",this.width+20).attr("height",this.master_detail_height).attr("transform","translate(-10, 1)")}};Rubix.prototype.marginLeft=function(a){if(!arguments.length)return this.margin.left;this.margin.left=10+a+10<this.margin.defaultLeft?this.margin.defaultLeft:10+a+10;this.axis.x.label.length&&this.opts.invertAxes&&(this.margin.left+=15);this.axis.y.label.length&&!this.opts.invertAxes&&(this.margin.left+=15);this.draw()};
Rubix.prototype.forceRedraw=function(){this.hasData=!1;for(var a in this.charts)this.hasData=!0,this.charts[a].forceRedraw(this);this.hasData?(this.canvas.select(".noData").style("display","none"),this.root.selectAll(".axis").style("display",null)):(this.canvas.select(".noData").style("display",null),this.root.selectAll(".axis").style("display","none"))};
Rubix.prototype.resizePath=function(a){var c=(a=+("e"==a))?1:-1,b=this.master_detail_height/3;return"M"+.5*c+","+b+"A6,6 0 0 "+a+" "+6.5*c+","+(b+6)+"V"+(2*b-6)+"A6,6 0 0 "+a+" "+.5*c+","+2*b+"ZM"+2.5*c+","+(b+8)+"V"+(2*b-8)+"M"+4.5*c+","+(b+8)+"V"+(2*b-8)};
Rubix.prototype._createBrushPath=function(){var a=this;this.brush_path&&this.brush_path.remove();this.brush_path=this.md_root.append("g");this.brush_path.attr("height",this.master_detail_height+2);this.brush_path.attr("width",this.md_root.attr("width"));this.brush_path.attr("class","x brush");this.brush_path.attr("clip-path","url(#"+this.master_id+"-clip-brush)");this.brush_path.call(this.brush);this.brush_path.selectAll(".extent").attr("stroke","none").attr("fill-opacity",.125).attr("shape-rendering",
"crispEdges");this.brush_path.selectAll(".resize").append("path").attr("d",function(c){return a.resizePath(c)}).style("fill","#EEE").style("stroke","#E9E9E9");this.brush_path.selectAll("rect").attr("height",this.master_detail_height+2);this.is_touch_device&&(this.brush_path.on("touchstart",function(){$(window).trigger("rubix.sidebar.off")}),this.brush_path.on("touchmove",function(){$(window).trigger("rubix.sidebar.off")}),this.brush_path.on("touchend",function(){$(window).trigger("rubix.sidebar.on")}));
this.extent.length||(this.extent=this.x2.domain(),this.brush.extent(this.extent),this._brush())};Rubix.prototype.bisectLeft=d3.bisector(function(a){return a.x}).left;Rubix.prototype.bisectRight=d3.bisector(function(a){return a.x}).right;
Rubix.prototype.move_tooltip_x=function(a,c,b){var d;c.length&&(d=d3.mean(c)/c.length);var e=a;if("column"===this.axis.x.range||"bar"===this.axis.x.range)a+=this.x.rangeBand()/2;c=this.root_elem;var f=(this.tooltip.outerWidth()-this.tooltip.width())/2,g=a+this.margin.left+f,h=d,n=c.width(),k=g+this.tooltip.outerWidth();if("column"===this.axis.x.range||"bar"===this.axis.x.range)a=e-this.x.rangeBand()/2;k>n&&(g-=k-a-this.margin.left+f);this.tooltip.show();this.tooltip.css({left:g,top:h});a="";var e=
this.tooltipFormatter.format.x.length?"datetime"===this.axis.x.type?d3.time.format(this.tooltipFormatter.format.x):d3.format(this.tooltipFormatter.format.x):function(a){return a},f=this.tooltipFormatter.format.y.length?"datetime"===this.axis.y.type?d3.time.format(this.tooltipFormatter.format.y):d3.format(this.tooltipFormatter.format.y):function(a){return a},l;for(l in b)g="datetime"===this.axis.x.type?e(new Date(b[l].x)):b[l].invert?e(this.x.invert(b[l].x)):e(b[l].x),h="datetime"===this.axis.y.type?
null!==b[l].y?f(new Date(b[l].y)):null:b[l].invert?null!==b[l].y?f(this.y.invert(b[l].y)):null:f(b[l].y),a="<div style='color: "+b[l].opts.color+"; margin-bottom: 2px; line-height: 22px;'><b style='position:relative; top: -5px; left: -2px;'><span style='font-size: 22px;'>\u25a0 </span><span style='position:relative; top: -3px; left: -2px;'>"+l+"</span></b></div>"+("<div style='font-size: 10px; margin-top: -10px;'>x : "+g+" </div>")+("<div style='font-size: 10px; margin-top: -5px;'>y : "+h+" </div><br>")+
a;a=a.slice(0,a.length-4);this.tooltip.html(a);this.tooltip.outerHeight()+d>=c.height()&&(h=this.margin.top,this.tooltip.css("top",h))};
Rubix.prototype.move_tooltip_y=function(a,c,b){try{var d;c.length&&(d=d3.max(c));c=d;if("column"===this.axis.x.range||"bar"===this.axis.x.range)d+=this.y.rangeBand()/2;var e=$(this.canvas.node()),f=(this.tooltip.outerWidth()-this.tooltip.width())/2,g=d+this.margin.left+f,h=e.width(),n=g+this.tooltip.outerWidth();if("column"===this.axis.x.range||"bar"===this.axis.x.range)d=c-this.y.rangeBand()/2;n>h&&(g-=n-d-this.margin.left+f);var k=e.height(),l=a+this.tooltip.outerHeight()+this.margin.bottom;l>k&&
(a-=l-k);this.tooltip.show();this.tooltip.css({left:g,top:a});d="";var m,q;m=this.tooltipFormatter.format.x.length?"datetime"===this.axis.x.type?d3.time.format(this.tooltipFormatter.format.x):d3.format(this.tooltipFormatter.format.x):function(a){return a};q=this.tooltipFormatter.format.y.length?"datetime"===this.axis.y.type?d3.time.format(this.tooltipFormatter.format.y):d3.format(this.tooltipFormatter.format.y):function(a){return a};for(var p in b){var r,s;r="datetime"===this.axis.y.type?q(new Date(b[p].y)):
b[p].invert?q(this.y.invert(b[p].y)):q(b[p].y);s="datetime"===this.axis.x.type?m(new Date(b[p].x)):b[p].invert?m(this.x.invert(b[p].x)):m(b[p].x);d="<div style='color: "+b[p].opts.color+"; margin-bottom: 2px'><b style='position:relative; top: -5px; left: -2px;'><span style='font-size: 22px;'>\u25a0 </span><span style='position:relative; top: -3px; left: -2px;'>"+p+"</span></b></div>"+("<div style='font-size: 10px; margin-top: -10px;'>x : "+r+" </div>")+("<div style='font-size: 10px; margin-top: -5px;'>y : "+
s+" </div><br>")+d}d=d.slice(0,d.length-4);this.tooltip.html(d)}catch(t){}};
Rubix.prototype.overlayX=function(a,c){try{if("ordinal"===a.axis.x.type){var b=c[0];if("column"===a.axis.x.range||"bar"===a.axis.x.range)b-=a.x.rangeBand()/2;var d=a.bisectLeft(a.crosshair_data,b,1)}else b=a.x.invert(c[0]+1),d=a.bisectLeft(a.crosshair_data,b,1);var e=a.crosshair_data[d-1],f=a.crosshair_data[d],g=b-e.x>f.x-b?f:e,h=g.y,n,b=[],d={},e=[],k;for(k in a.charts)try{if(h.hasOwnProperty(k)){if("ordinal"===a.axis.x.type){if(null!==h[k]&&null!==g.others[k].y0){e.push(!0);var l=g.x,m=a.y(h[k]);
if("column"===a.axis.x.range||"bar"===a.axis.x.range)l=a.grouped&&a.charts[k].hasOwnProperty("count")?g.x+a.x.rangeBand()/a.charts[k].layers.length*a.charts[k].count+a.x.rangeBand()/(2*a.charts[k].layers.length):l+a.x.rangeBand()/2;a.charts[k].focus.attr("transform","translate("+l+","+m+")").style("display",null);n="column"===a.axis.x.range||"bar"===a.axis.x.range?a.grouped&&a.charts[k].hasOwnProperty("count")?g.x+a.x.rangeBand()/2:l:l;b.push(m);d[k]={x:l,y:h[k]?m:null,opts:a.charts[k].opts,invert:!0}}}else e.push(!0),
l=a.x(g.x),m=a.y(h[k]),a.charts[k].focus.attr("transform","translate("+l+","+m+")").style("display",null),n=l,b.push(m),d[k]={x:g.x,y:h[k],opts:a.charts[k].opts,invert:!1};if(e.length)a.charts[k].on_focus(l,m)}else a.charts[k].focus.style("display","none"),a.charts[k].off_focus()}catch(q){}if(e.length){if("ordinal"===a.axis.x.type){l=g.x;if("column"===a.axis.x.range||"bar"===a.axis.x.range)l+=a.x.rangeBand()/2;a.focusLine.style("display",null).attr("transform","translate("+l+",0)")}else a.focusLine.style("display",
null).attr("transform","translate("+a.x(g.x)+",0)");a.move_tooltip_x(n,b,d)}}catch(p){}};
Rubix.prototype.overlayY=function(a,c){var b=c[1];try{if("ordinal"===a.axis.y.type){if("column"===a.axis.y.range||"bar"===a.axis.y.range)b-=a.y.rangeBand()/2}else b=a.y.invert(b);var d=a.bisectRight(a.crosshair_data,b,1),e=a.crosshair_data[d-1],f=a.crosshair_data[d],g=b-e.x>f.x-b?f:e,h=g.y,n,b=[],d={},e=[],k;for(k in a.charts)try{if(h.hasOwnProperty(k)){if("ordinal"===a.axis.y.type){if(null!==h[k]&&null!==g.others[k].y0){e.push(!0);var l=g.x,m=a.x(h[k]);if("column"===a.axis.y.range||"bar"===a.axis.y.range)l=
a.grouped&&a.charts[k].hasOwnProperty("count")?g.x+a.y.rangeBand()/a.charts[k].layers.length*a.charts[k].count+a.y.rangeBand()/(2*a.charts[k].layers.length):l+a.y.rangeBand()/2;a.charts[k].focus.attr("transform","translate("+m+","+l+")").style("display",null);n=l;b.push(m);d[k]={x:m,y:l,opts:a.charts[k].opts,invert:!0}}}else e.push(!0),l=a.y(g.x),m=a.x(h[k]),a.charts[k].focus.attr("transform","translate("+m+","+l+")").style("display",null),n=l,b.push(m),d[k]={x:h[k],y:g.x,opts:a.charts[k].opts,invert:!1};
if(e.length)a.charts[k].on_focus(m,l)}else a.charts[k].focus.style("display","none"),a.charts[k].off_focus()}catch(q){}if(e.length){if("ordinal"===a.axis.y.type){l=g.x;if("column"===a.axis.y.range||"bar"===a.axis.y.range)l+=a.y.rangeBand()/2;a.focusLine.style("display",null).attr("transform","translate(0,"+l+")")}else a.focusLine.style("display",null).attr("transform","translate(0,"+a.y(g.x)+")");a.move_tooltip_y(n,b,d)}}catch(p){}};
Rubix.prototype.resetFocus=function(a){if(this.width&&this.height){this.focusLine&&this.focusLine.remove();this.symbols&&this.symbols.remove();this.overlay&&this.overlay.remove();this.xlabel&&this.xlabel.remove();this.ylabel&&this.ylabel.remove();var c=this;this.axis.x.label.length&&(this.xlabel=this.root.append("text"),this.xlabel.style("font-size","12px"),this.xlabel.style("font-weight","bold"),this.xlabel.style("font-family",'Lato, "Lucida Grande", Arial, Helvetica, sans-serif'),this.xlabel.attr("fill",
"steelblue"),this.xlabel.attr("stroke","none"),this.xlabel.style("text-anchor","middle"),this.opts.invertAxes?(this.xlabel.attr("y",-this.margin.left+20),this.xlabel.attr("x",-parseInt(this.root.attr("height"))/2),this.xlabel.attr("transform","rotate(-90)"),this.xlabel.text(this.axis.y.label)):(this.xlabel.attr("y",parseInt(this.root.attr("height"))+this.margin.bottom-15),this.xlabel.attr("x",parseInt(this.root.attr("width"))/2),this.xlabel.text(this.axis.x.label)));this.axis.y.label.length&&(this.ylabel=
this.root.append("text"),this.ylabel.style("font-size","12px"),this.ylabel.style("font-weight","bold"),this.ylabel.style("font-family",'Lato, "Lucida Grande", Arial, Helvetica, sans-serif'),this.ylabel.attr("fill","steelblue"),this.ylabel.attr("stroke","none"),this.ylabel.style("text-anchor","middle"),this.opts.invertAxes?(this.ylabel.attr("y",parseInt(this.root.attr("height"))+this.margin.bottom-15),this.ylabel.attr("x",parseInt(this.root.attr("width"))/2),this.ylabel.text(this.axis.x.label)):(this.ylabel.attr("y",
-this.margin.left+20),this.ylabel.attr("x",-parseInt(this.root.attr("height"))/2),this.ylabel.attr("transform","rotate(-90)"),this.ylabel.text(this.axis.y.label)));this.focusLine=this.opts.invertAxes?this.focus_line_group.append("line").attr("x1",0).attr("y1",0).attr("x2",this.width).attr("y2",0).attr("stroke","#D4D4D4").attr("stroke-width",1).attr("shape-rendering","crispEdges").style("display","none").attr("class","focus-line"):this.focus_line_group.append("line").attr("x1",0).attr("y1",0).attr("x2",
0).attr("y2",this.height).attr("stroke","#D4D4D4").attr("stroke-width",1).attr("shape-rendering","crispEdges").style("display","none").attr("class","focus-line");this.symbols=this.symbols_group.append("g");for(var b in c.charts)c.charts[b].on_complete_draw();var d=[];for(b in c.charts)d.push(b);"column"!=this.axis.x.range&&"bar"!=this.axis.x.range||d.reverse();for(var e=0;e<d.length;e++)b=d[e],c.charts[b].setupFocus();this.master_detail&&(a||this._createBrushPath());this.overlay=this.root.append("rect");
this.overlay.attr("class","overlay");this.overlay.attr("width",this.width);this.overlay.attr("height",this.height);this.overlay.attr("fill","none");this.overlay.attr("pointer-events","all");this.overlay.attr("clip-path","url(#"+this.master_id+"-clip)");a=function(){$(window).trigger("rubix.sidebar.off");d3.event.preventDefault();c.focusLine.style("display",null);$(this).focus()};b=function(){$(window).trigger("rubix.sidebar.off");d3.event.preventDefault();$(this).focus();if(c.hasData){var a=c.is_touch_device?
d3.touches(this)[0]:d3.mouse(this);c.opts.invertAxes?c.overlayY.call(this,c,a):c.overlayX.call(this,c,a)}};d=function(){$(window).trigger("rubix.sidebar.on");d3.event.preventDefault();$(this).focus();c.tooltip.hide();for(var a in c.charts)try{c.charts[a].focus.style("display","none"),c.charts[a].off_focus()}catch(b){}c.focusLine.style("display","none")};c.is_touch_device?(this.overlay.on("touchstart",a),this.overlay.on("touchmove",b),this.overlay.on("touchend",d)):(this.overlay.on("mouseover",a),
this.overlay.on("mousemove",b),this.overlay.on("mouseout",d))}};Rubix.prototype.runCommand=function(a){for(var c in this.charts)try{this.charts[c][a](this)}catch(b){}};
Rubix.prototype.resetLabelHandlers=function(){var a=this;$("."+this.master_id+"-legend-labels").css({opacity:.9});$("."+this.master_id+"-legend-labels").off().on({hover:function(a){if(!$(this).hasClass("toggle"))switch(a.type){case "mouseenter":$(this).css({opacity:1});break;case "mouseleave":$(this).css({opacity:.9})}},click:function(c){var b=$(this).hasClass("toggle");c=$(this).attr("data-name");var d=$(this).attr("data-type")||"";if(b){$(this).css({opacity:1});$(this).removeClass("toggle");b=a.chart_stack[c];
a.charts[c]=b;delete a.chart_stack[c];if(d.length){var e=a.column_stack_data_stack,f=a.column_stack_data;"astack"===d&&(e=a.area_stack_data_stack,f=a.area_stack_data);for(b=d=0;b<e.length;b++)if(e[b]&&(h=e[b].key,h===c)){d=e[b].orderKey;g=e[b];e.splice(b,1);break}f.splice(d,0,g)}g=a.data_stack[c];a.data[c]=g;delete a.data_stack[c];a.charts[c].show()}else{$(this).css({opacity:.2});$(this).addClass("toggle");b=a.charts[c];b.hidden();delete a.charts[c];a.chart_stack[c]=b;if(d.length){e=a.column_stack_data;
f=a.column_stack_data_stack;"astack"===d&&(e=a.area_stack_data,f=a.area_stack_data_stack);for(var g,b=d=0;b<e.length;b++)if(e[b]){var h=e[b].key;if(h===c){d=e[b].orderKey;g=e[b];e.splice(b,1);break}}f.splice(d,0,g)}g=a.data[c];a.data_stack[c]=g;delete a.data[c]}a.draw();a.draw()}})};
Rubix.prototype.line_series=function(a){a=a||{};a.name=a.name||this._generate_name();if(this.charts.hasOwnProperty(a.name))throw Error("Series exists: "+name);a=new Rubix.LineSeries(this,a);this.charts[a.name]=a;this.legend.append("<div class='"+this.master_id+"-legend-labels' data-name='"+a.name+"' style='cursor: pointer; display: inline-block; font-weight: bold; margin-right: 10px; color: "+a.opts.color+"'><span style='font-size: 22px;'>\u25a0 </span><span style='font-size: 12px; position:relative; top: -3px; left: -2px;'>"+
a.name+"</span></div>");this.resetLabelHandlers();return a};
Rubix.prototype.area_series=function(a){a=a||{};a.name=a.name||this._generate_name();if(this.charts.hasOwnProperty(a.name))throw Error("Series exists: "+name);if(this.stacked)return a=new Rubix.StackedAreaSeries(this,a),this.charts[a.name]=a,this.legend.append("<div class='"+this.master_id+"-legend-labels' data-name='"+a.name+"' data-type='astack' style='cursor: pointer; display: inline-block; font-weight: bold; margin-right: 10px; color: "+a.opts.color+"'><span style='font-size: 22px;'>\u25a0 </span><span style='font-size: 12px; position:relative; top: -3px; left: -2px;'>"+
a.name+"</span></div>"),this.resetLabelHandlers(),a;a=new Rubix.AreaSeries(this,a);this.charts[a.name]=a;this.legend.append("<div class='"+this.master_id+"-legend-labels' data-name='"+a.name+"' style='cursor: pointer; display: inline-block; font-weight: bold; margin-right: 10px; color: "+a.opts.color+"'><span style='font-size: 22px;'>\u25a0 </span><span style='font-size: 12px; position:relative; top: -3px; left: -2px;'>"+a.name+"</span></div>");this.resetLabelHandlers();return a};
Rubix.prototype._generate_name=function(){return"Series "+ ++this.chart_counter};
Rubix.prototype.column_series=function(a){a=a||{};a.name=a.name||this._generate_name();if(this.charts.hasOwnProperty(a.name))throw Error("Series exists: "+name);if(!1!==this.opts.invertAxes||"column"!==this.opts.axis.x.range)this.opts.invertAxes=!1,this.opts.axis.x.type="ordinal",this.opts.axis.x.range="column",this.setup();a=new Rubix.ColumnSeries(this,a);this.charts[a.name]=a;this.legend.append("<div class='"+this.master_id+"-legend-labels' data-name='"+a.name+"' data-type='cstack' style='cursor: pointer; display: inline-block; font-weight: bold; margin-right: 10px; color: "+
a.opts.color+"'><span style='font-size: 22px;'>\u25a0 </span><span style='font-size: 12px; position:relative; top: -3px; left: -2px;'>"+a.name+"</span></div>");this.resetLabelHandlers();return a};
Rubix.prototype.bar_series=function(a){a=a||{};a.name=a.name||this._generate_name();if(this.charts.hasOwnProperty(a.name))throw Error("Series exists: "+name);if(!0!==this.opts.invertAxes||"column"!==this.opts.axis.x.range)this.opts.invertAxes=!0,this.opts.axis.x.type="ordinal",this.opts.axis.x.range="column",this.setup();a=new Rubix.ColumnSeries(this,a);this.charts[a.name]=a;this.legend.append("<div class='"+this.master_id+"-legend-labels' data-name='"+a.name+"' data-type='cstack' style='cursor: pointer; display: inline-block; font-weight: bold; margin-right: 10px; color: "+
a.opts.color+"'><span style='font-size: 22px;'>\u25a0 </span><span style='font-size: 12px; position:relative; top: -3px; left: -2px;'>"+a.name+"</span></div>");this.resetLabelHandlers();return a};window.Rubix=window.Rubix||{};
Rubix.AreaSeries=function(a,c){this.opts=c;this.opts.color=this.opts.color||"steelblue";this.opts.marker=this.opts.marker||"circle";this.show_markers=this.opts.show_markers;if(!this.opts.hasOwnProperty("name"))throw Error("AreaSeries should have a 'name' property");this.name=this.opts.name;this.chart_hidden=!1;this.temp_stack=[];this.animating=this.setup=!1;this._setup(a)};
Rubix.AreaSeries.prototype._setup=function(a){this.rubix=a;this.root=this.rubix.root;this.data=this.rubix.data;this.width=this.rubix.width;this.height=this.rubix.height;this.area_series=this.rubix.root_area_series;this.show_markers=void 0===this.show_markers?this.rubix.show_markers:this.show_markers;if(this.master_detail=this.rubix.master_detail)this.md_root=this.rubix.md_root;this.id||(this.id=this.rubix.uid("area"));var c=this;this.line=d3.svg.line();this.line.defined(function(a){return null!==
a.x&&null!==a.y});this.line.x(function(a){return c.rubix.opts.invertAxes?c.rubix.x(a.y):"column"===c.rubix.axis.x.range||"bar"===c.rubix.axis.x.range?c.rubix.x(a.x)+c.rubix.x.rangeBand()/2:c.rubix.x(a.x)});this.line.y(function(a){return c.rubix.opts.invertAxes?"column"===c.rubix.axis.y.range||"bar"===c.rubix.axis.y.range?c.rubix.y(a.x)+c.rubix.y.rangeBand()/2:c.rubix.y(a.x):c.rubix.y(a.y)});this.line.interpolate(this.rubix.interpolate);this.area=d3.svg.area();this.area.defined(this.line.defined());
this.rubix.opts.invertAxes?(this.area.x0(function(a){return c.rubix.x(0)}),this.area.x1(function(a){return c.rubix.x(a.y)}),this.area.y(function(a){return"column"===c.rubix.axis.y.range||"bar"===c.rubix.axis.y.range?c.rubix.y(a.x)+c.rubix.y.rangeBand()/2:c.rubix.y(a.x)})):(this.area.x(function(a){return"column"===c.rubix.axis.x.range||"bar"===c.rubix.axis.x.range?c.rubix.x(a.x)+c.rubix.x.rangeBand()/2:c.rubix.x(a.x)}),this.area.y0(function(a){return c.rubix.y(0)}),this.area.y1(function(a){return c.rubix.y(a.y)}));
this.area.interpolate(this.rubix.interpolate);this.master_detail&&(this.master_line=d3.svg.line(),this.master_line.defined(function(a){return null!==a.x&&null!==a.y}),this.master_line.x(function(a){return c.rubix.opts.invertAxes?c.rubix.x2(a.y):c.rubix.x2(a.x)}),this.master_line.y(function(a){return c.rubix.opts.invertAxes?c.rubix.y2(a.x):c.rubix.y2(a.y)}),this.master_line.interpolate(this.rubix.interpolate),this.master_area=d3.svg.area(),this.master_area.defined(this.master_line.defined()),this.area.interpolate(this.rubix.interpolate),
this.rubix.opts.invertAxes?(this.master_area.x0(function(a){return c.rubix.x2(0)}),this.master_area.x1(function(a){return c.rubix.x2(a.y)}),this.master_area.y(function(a){return c.rubix.y2(a.x)})):(this.master_area.x(function(a){return c.rubix.x2(a.x)}),this.master_area.y0(function(a){return c.rubix.y2(0)}),this.master_area.y1(function(a){return c.rubix.y2(a.y)})),this.master_area.interpolate(this.rubix.interpolate))};Rubix.AreaSeries.prototype.redraw=function(a){this._setup(a);this.draw()};
Rubix.AreaSeries.prototype.noRedraw=function(a){this._setup(a);this.draw(!0)};Rubix.AreaSeries.prototype.addData=function(a){if(!(a instanceof Array))if(a instanceof Object){if(!a.hasOwnProperty("x")&&!a.hasOwnProperty("y"))throw Error("Object must be in the form: {x: ..., y: ...}");a=[a]}else throw Error("Data must be an array or object");a.length&&(a.sort(function(a,b){return a.x>b.x?1:a.x===b.x?0:-1}),this.data[this.name]=a,this.rubix.resetAxis(!1),this.rubix.forceRedraw(),this._animate_draw())};
Rubix.AreaSeries.prototype.draw=function(a){this.name&&this.data&&this.data.hasOwnProperty(this.name)&&this.data[this.name].length&&(this.area_series.selectAll("."+this.id)[0].length?this.rubix.runCommand("globalRedraw"):(this.area_series.selectAll("."+this.id+".clipped").remove(),this.strokePath1=this.area_series.append("path").attr("class",this.id+" line").datum(this.data[this.name]).attr("d",this.line).attr("stroke","black").attr("fill","none").attr("stroke-linecap","round").attr("stroke-width",
5).attr("stroke-opacity",.05000000000000001).attr("transform","translate(1,1)"),this.strokePath2=this.area_series.append("path").attr("class",this.id+" line").datum(this.data[this.name]).attr("d",this.line).attr("stroke","black").attr("fill","none").attr("stroke-linecap","round").attr("stroke-width",3).attr("stroke-opacity",.1).attr("transform","translate(1,1)"),this.strokePath3=this.area_series.append("path").attr("class",this.id+" line").datum(this.data[this.name]).attr("d",this.line).attr("stroke",
"black").attr("fill","none").attr("stroke-linecap","round").attr("stroke-width",1).attr("stroke-opacity",.15000000000000002).attr("transform","translate(1,1)"),this.areaPath=this.area_series.append("path").attr("class",this.id+" area").datum(this.data[this.name]).attr("d",this.area).attr("fill",this.opts.color).attr("fill-opacity",.5).attr("stroke","none"),this.linePath=this.area_series.append("path").datum(this.data[this.name]).attr("class",this.id+" line").attr("stroke",this.opts.color).attr("fill",
"none").attr("stroke-linecap","round").attr("d",this.line).attr("stroke-width",2),this.master_detail&&(this.md_root.select(".md-layers").selectAll("."+this.id+".clipped").remove(),this.masterLinePath=this.md_root.select(".md-layers").append("path").datum(this.data[this.name]).attr("class",this.id+" line").attr("stroke",this.opts.color).attr("fill","none").attr("stroke-linecap","round").attr("d",this.master_line).attr("stroke-width",2),this.masterLinePath.attr("clip-path","url(#"+this.rubix.master_id+
"-clip)"),this.masterLinePath.classed("clipped",!0),this.masterAreaPath=this.md_root.select(".md-layers").append("path").attr("class",this.id+" area").datum(this.data[this.name]).attr("d",this.master_area).attr("fill",this.opts.color).attr("fill-opacity",.5).attr("stroke","none"),this.masterAreaPath.attr("clip-path","url(#"+this.rubix.master_id+"-clip)"),this.masterAreaPath.classed("clipped",!0),this.dataChanged&&(this.rubix.resetExtent(),this.dataChanged=!1),this.strokePath1.attr("clip-path","url(#"+
this.rubix.master_id+"-clip)"),this.strokePath2.attr("clip-path","url(#"+this.rubix.master_id+"-clip)"),this.strokePath3.attr("clip-path","url(#"+this.rubix.master_id+"-clip)"),this.linePath.attr("clip-path","url(#"+this.rubix.master_id+"-clip)"),this.strokePath1.classed("clipped",!0),this.strokePath2.classed("clipped",!0),this.strokePath3.classed("clipped",!0),this.linePath.classed("clipped",!0),this.areaPath.classed("clipped",!0)),this.areaPath.attr("clip-path","url(#"+this.rubix.master_id+"-clip)"),
this.setup=!0),this.rubix.resetFocus(a))};Rubix.AreaSeries.prototype.updatePoint=function(a,c,b){this.addPoint(a,c,b)};
Rubix.AreaSeries.prototype.removePoint=function(a,c){if(this.chart_hidden)this.temp_stack.push({type:"removePoint",ref:a});else{this.data[this.name]||(this.data[this.name]=[]);for(var b=0;b<this.data[this.name].length;b++)if(this.data[this.name][b].x===a){this.data[this.name].splice(b,1);break}this.master_detail&&(this.dataChanged=!0);c||(this.setup?this._animate_draw():(this.rubix.resetAxis(!0),this.rubix.forceRedraw()))}};
Rubix.AreaSeries.prototype.addPoint=function(a,c,b){if(!(a instanceof Object)||a instanceof Array)throw Error("Object required for addPoint");if(!a.hasOwnProperty("x")&&!a.hasOwnProperty("y"))throw Error("Object must be in the form: {x: ..., y: ...}");if(this.chart_hidden)this.temp_stack.push({type:"addPoint",data:a,shift:c});else{this.data[this.name]||(this.data[this.name]=[]);for(var d=!1,e=0;e<this.data[this.name].length;e++)if(this.data[this.name][e].x===a.x){this.data[this.name][e].y=a.y;d=!0;
break}d||this.data[this.name].push(a);this.data[this.name].sort(function(a,b){return a.x>b.x?1:a.x===b.x?0:-1});this.rubix.opts.interval?this.rubix.opts.interval<this.data[this.name].length&&this.data[this.name].shift():c&&this.data[this.name].shift();this.master_detail&&(this.dataChanged=!0);b||(this.setup?this._animate_draw():(this.rubix.resetAxis(!0),this.rubix.forceRedraw()))}};
Rubix.AreaSeries.prototype._animate_draw=function(a){a=this.root.selectAll(".y.axis").selectAll("text")[0];for(var c=[],b=0;b<a.length;b++)c.push(a[b].getBBox().width);d3.max(c);this.rubix.resetAxis(!1);a=this.root.selectAll(".y.axis").selectAll("text")[0];c=[];for(b=0;b<a.length;b++)c.push(a[b].getBBox().width);a=d3.max(c);this.rubix.marginLeft(a);this.rubix.resetFocus()};Rubix.AreaSeries.prototype.hidden=function(){this.chart_hidden=!0};
Rubix.AreaSeries.prototype.show=function(){for(this.chart_hidden=!1;1<this.temp_stack.length;){var a=this.temp_stack.shift();"addPoint"===a.type?this.addPoint(a.data,a.shift,!0):this.removePoint(a.ref)}this.temp_stack.length&&(a=this.temp_stack.shift(),"addPoint"===a.type?this.addPoint(a.data,a.shift,!0):this.removePoint(a.ref))};
Rubix.AreaSeries.prototype.globalRedraw=function(a){this.area_series.selectAll("."+this.id+".line").attr("d",this.line);this.area_series.selectAll("."+this.id+".area").attr("d",this.area)};Rubix.AreaSeries.prototype.forceRedraw=function(a){this.redraw(a)};
Rubix.AreaSeries.prototype.on_complete_draw=function(){if(this.setup){var a=this,c=this.data[this.name];if(void 0!==this.opts.marker&&this.show_markers)switch(this.master_detail&&this.rubix.symbols.attr("clip-path","url(#"+a.rubix.master_id+"-clip-symbols)"),this.markers=this.rubix.symbols.selectAll("."+this.id+"-marker"),this.opts.marker){case "circle":case "cross":case "square":case "diamond":case "triangle-up":case "triangle-down":var b=d3.svg.symbol();b.type(this.opts.marker);c=this.markers.data(c);
c.enter().append("path").attr("d",b).attr("class",this.id+"-marker").attr("fill",this.opts.color).style("display",function(a){return null===a.y?"none":null}).attr("stroke","white").attr("transform",function(b){var c=b.y;isNaN(c)&&(c=0);if(a.rubix.opts.invertAxes){var f=a.rubix.y(b.x);b=a.rubix.x(c);if("column"===a.rubix.axis.y.range||"bar"===a.rubix.axis.y.range)f+=a.rubix.y.rangeBand()/2}else if(f=a.rubix.y(c),b=a.rubix.x(b.x),"column"===a.rubix.axis.x.range||"bar"===a.rubix.axis.x.range)b+=a.rubix.x.rangeBand()/
2;return"translate("+b+","+f+")"});c.exit().remove();break;default:throw Error("Unknown marker type : "+this.opts.marker);}}};
Rubix.AreaSeries.prototype.setupFocus=function(){if(this.setup)switch(this.focus&&this.focus.remove(),this.focus=this.rubix.focus_group.append("g"),this.focus.attr("class","focus"),this.focus.style("display","none"),this.opts.marker){case "circle":case "cross":case "square":case "diamond":case "triangle-up":case "triangle-down":var a=d3.svg.symbol();a.type(this.opts.marker);this.focus.append("path").attr("d",a).attr("fill",this.opts.color).attr("stroke","white").attr("stroke-width",2);break;default:throw Error("Unknown marker type : "+
this.opts.marker);}};Rubix.AreaSeries.prototype.on_focus=function(){this.setup&&this.linePath.attr("stroke-width",3)};Rubix.AreaSeries.prototype.off_focus=function(){this.setup&&this.linePath.attr("stroke-width",2)};window.Rubix=window.Rubix||{};
Rubix.ColumnSeries=function(a,c){this.type="column_series";this.opts=c;this.opts.color=this.opts.color||"steelblue";this.opts.marker=this.opts.marker||"circle";this.show_markers=this.opts.show_markers;if(!this.opts.hasOwnProperty("name"))throw Error("ColumnSeries should have a 'name' property");this.name=this.opts.name;this.chart_hidden=!1;this.temp_stack=[];this.setup=!1;this.last_stack=[];this.last_stack_name="";this.last_stack_added=!1;this.count=0;this._setup(a)};
Rubix.ColumnSeries.prototype._setup=function(a){this.rubix=a;this.rubix.stacked=!0;this.root=this.rubix.root;this.data=this.rubix.data;this.width=this.rubix.width;this.height=this.rubix.height;this.stack=this.rubix.column_stack;this.offset=this.rubix.column_offset;this.cb_series=this.rubix.root_cb_series;this.column_stack=this.rubix.column_stack_data;this.show_markers=void 0===this.show_markers?this.rubix.show_markers:this.show_markers;this.grouped=this.rubix.grouped;this.id||(this.id=this.rubix.uid("stacked-column"))};
Rubix.ColumnSeries.prototype.redraw=function(a){this._setup(a);this.draw()};Rubix.ColumnSeries.prototype.noRedraw=function(a){this._setup(a);this.draw(!0)};
Rubix.ColumnSeries.prototype.addData=function(a){if(!(a instanceof Array))if(a instanceof Object){if(!a.hasOwnProperty("x")&&!a.hasOwnProperty("y"))throw Error("Object must be in the form: {x: ..., y: ...}");a=[a]}else throw Error("Data must be an array or object");if(a.length){a.sort(function(a,b){return a.x>b.x?1:a.x===b.x?0:-1});var c=0,b=[],d;for(d in this.data){var e=this.data[d].length;if(e>c)for(c=e,b=[],e=0;e<c;e++)b.push(this.data[d][e].x)}this.rubix.maxLen=c;this.data[this.name]=a;for(d in this.data)if(e=
this.data[d].length,e<c){a=b.concat();for(e=0;e<this.data[d].length;e++){var f=a.indexOf(this.data[d][e].x);a.splice(f,1)}for(e=0;e<a.length;e++)this.rubix.charts[d].addPoint({x:a[e],y:null})}this.column_stack.push({key:this.name,color:this.opts.color,marker:this.opts.marker,values:this.data[this.name],orderKey:this.column_stack.length});this.rubix.resetAxis();this.rubix.forceRedraw();this._animate_draw()}};
Rubix.ColumnSeries.prototype._createRect=function(){var a=this,c=this.columnGroup.selectAll("rect").data(function(a){return a.values}).enter().append("rect").attr("stroke","white");this.grouped?this.rubix.opts.invertAxes?(c.attr("x",function(b,c,e){b=a.rubix.x(0);return isNaN(b)?null:b}),c.attr("y",function(b,c,e){return a.rubix.y(b.x)+a.rubix.y.rangeBand()/a.layers.length*e}),c.attr("class",function(b,c,e){return"column-"+(a.rubix.y(b.x)+a.rubix.y.rangeBand()/a.layers.length*(a.layers.length-1)+
a.rubix.y.rangeBand()/(2*a.layers.length))}),c.attr("width",function(b){b=Math.abs(a.rubix.x(b.y)-a.rubix.x(0));return isNaN(b)?null:b}),c.attr("height",a.rubix.y.rangeBand()/a.layers.length),c.attr("transform",function(b){var c=a.rubix.x(b.y_new)-a.rubix.x(0);return 0>b.y?"translate("+-Math.abs(c)+",0)":"translate(0,0)"})):(c.attr("x",function(b,c,e){return a.rubix.x(b.x)+a.rubix.x.rangeBand()/a.layers.length*e}),c.attr("y",function(b){b=a.rubix.y(0);return isNaN(b)?null:b}),c.attr("class",function(b,
c,e){return"column-"+(a.rubix.x(b.x)+a.rubix.x.rangeBand()/a.layers.length*(a.layers.length-1)+a.rubix.x.rangeBand()/(2*a.layers.length))}),c.attr("width",a.rubix.x.rangeBand()/a.layers.length),c.attr("height",function(b){b=Math.abs(a.rubix.y(b.y)-a.rubix.y(0));return isNaN(b)?null:b}),c.attr("transform",function(b){var c=a.rubix.y(b.y_new)-a.rubix.y(0);return 0<b.y?"translate(0,"+-Math.abs(c)+")":"translate(0,0)"})):this.rubix.opts.invertAxes?(c.attr("x",function(b){b=a.rubix.x(b.y0);return isNaN(b)?
null:b}),c.attr("y",function(b){return a.rubix.y(b.x)}),c.attr("class",function(b){return"column-"+(a.rubix.y(b.x)+a.rubix.y.rangeBand()/2)}),c.attr("width",function(b){b=Math.abs(a.rubix.x(b.y0)-a.rubix.x(b.y+b.y0));return isNaN(b)?null:b}),c.attr("height",a.rubix.y.rangeBand()),c.attr("transform",function(b){return 0>b.y?"translate("+-Math.abs(a.rubix.x(b.y0)-a.rubix.x(b.y+b.y0))+",0)":null})):(c.attr("x",function(b){return a.rubix.x(b.x)}),c.attr("y",function(b){b=a.rubix.y(b.y0);return isNaN(b)?
null:b}),c.attr("class",function(b){return"column-"+(a.rubix.x(b.x)+a.rubix.x.rangeBand()/2)}),c.attr("width",a.rubix.x.rangeBand()),c.attr("height",function(b){b=Math.abs(a.rubix.y(b.y0)-a.rubix.y(b.y+b.y0));return isNaN(b)?null:b}),c.attr("transform",function(b){return 0<b.y?"translate(0,"+-Math.abs(a.rubix.y(b.y0)-a.rubix.y(b.y+b.y0))+")":null}))};
Rubix.ColumnSeries.prototype.draw=function(a){if(this.name&&this.data&&this.data.hasOwnProperty(this.name)&&this.data[this.name].length){var c=this.layers;try{this.layers=this.stack(this.column_stack)}catch(b){this.layers=c}if(!this.grouped)for(var c=this.rubix.maxLen,d=0;d<c;d++){for(var e=this.layers[0].values[d].x,f=null,g=0;g<this.layers.length;g++)for(var h=0;h<c;h++)try{if(this.layers[g].values[h].x===e){0<=this.layers[g].values[h].y&&(null===this.layers[g].values[h].y?this.layers[g].values[h].y0=
null:(null===f&&(f=0),this.layers[g].values[h].y0=f,f+=this.layers[g].values[h].y));break}}catch(n){this.layers[g].values.push({x:e,y:null,y0:null,y_new:null})}f=null;for(g=this.layers.length-1;0<=g;g--)for(h=0;h<c;h++)try{if(this.layers[g].values[h].x===e){0>this.layers[g].values[h].y&&(null===this.layers[g].values[h].y?this.layers[g].values[h].y0=null:(null===f&&(f=0),this.layers[g].values[h].y0=-f,f+=Math.abs(this.layers[g].values[h].y)));break}}catch(k){this.layers[g].values.push({x:e,y:null,
y0:null,y_new:null})}}var l=this;if(this.cb_series.selectAll("."+this.id)[0].length)this.rubix.runCommand("globalRedraw");else{try{this.cb_series.selectAll(".column-layer").remove();var m=this.cb_series.selectAll(".column-layer").data(this.layers,function(a,b){a.key===l.name&&(l.count=b);return a.key});this.columnGroup=m.enter().append("g");this.columnGroup.attr("class","column-layer").attr("fill",function(a){return a.color}).attr("fill-opacity",1);this._createRect();m.exit().remove()}catch(q){}this.setup=
!0}this.rubix.resetFocus(a)}};Rubix.ColumnSeries.prototype.update=function(a){if(!(a instanceof Array))if(a instanceof Object){if(!a.hasOwnProperty("x")&&!a.hasOwnProperty("y"))throw Error("Object must be in the form: {x: ..., y: ...}");a=[a]}else throw Error("Data must be an array or object");a.sort(function(a,b){return a.x>b.x?1:a.x===b.x?0:-1});this.data[this.name]=a;this.setup?this._animate_draw():(this.rubix.resetAxis(!0),this.rubix.forceRedraw())};
Rubix.ColumnSeries.prototype.updatePoint=function(a,c,b){this.addPoint(a,c,b)};
Rubix.ColumnSeries.prototype.removePoint=function(a,c){if(this.chart_hidden)this.temp_stack.push({type:"removePoint",ref:a});else{this.data[this.name]||(this.data[this.name]=[]);for(var b=!1,d=0,e=0;e<this.data[this.name].length;e++)if(this.data[this.name][e].x===a){this.data[this.name][e].y=null;this.data[this.name][e].y0=null;this.data[this.name][e].y_new=null;d=e;b=!0;break}if(b){b=!1;for(e=0;e<this.column_stack.length;e++){var f=this.column_stack[e];try{if(f.values[d].x===a&&null!==f.values[d].y){b=
!0;break}}catch(g){}}if(!b)for(e=0;e<this.column_stack.length;e++)this.column_stack[e].values.splice(d,1);d=0;for(e in this.data)b=this.data[e].length,b>d&&(d=b);this.rubix.maxLen=d;c||(this.rubix.resetAxis(),this.rubix.forceRedraw(),this._animate_draw())}}};
Rubix.ColumnSeries.prototype.addPoint=function(a,c,b){if(!(a instanceof Object)||a instanceof Array)throw Error("Object required for addPoint");if(!a.hasOwnProperty("x")&&!a.hasOwnProperty("y"))throw Error("Object must be in the form: {x: ..., y: ...}");if(this.chart_hidden)this.temp_stack.push({type:"addPoint",data:a,shift:c});else{this.data[this.name]||(this.data[this.name]=[]);for(var d=!1,e=0;e<this.data[this.name].length;e++)if(this.data[this.name][e].x===a.x){this.data[this.name][e].y=a.y;d=
!0;break}d||this.data[this.name].push(a);this.data[this.name].sort(function(a,b){return a.x>b.x?1:a.x===b.x?0:-1});d=!1;for(e=0;e<this.column_stack.length;e++)if(this.column_stack[e].key===this.name){d=!0;break}this.rubix.opts.interval?this.rubix.opts.interval<this.data[this.name].length&&this.data[this.name].shift():c&&this.data[this.name].shift();a=0;c=[];for(e in this.data)if(d=this.data[e].length,d>a)for(a=d,c=[],d=0;d<a;d++)c.push(this.data[e][d].x);this.rubix.maxLen=a;for(e in this.data)if(d=
this.data[e].length,d<a){for(var d=c.concat(),f=0;f<this.data[e].length;f++){var g=d.indexOf(this.data[e][f].x);d.splice(g,1)}for(f=0;f<d.length;f++)this.rubix.charts[e].addPoint({x:d[f],y:null})}b||(this.rubix.resetAxis(),this.rubix.forceRedraw(),this._animate_draw())}};
Rubix.ColumnSeries.prototype._animate_draw=function(){for(var a=this.root.selectAll(".y.axis").selectAll("text")[0],c=[],b=0;b<a.length;b++)c.push(a[b].getBBox().width);d3.max(c);this.rubix.resetAxis(!0);this.rubix.runCommand("globalRedraw");a=this.root.selectAll(".y.axis").selectAll("text")[0];c=[];for(b=0;b<a.length;b++)c.push(a[b].getBBox().width);a=d3.max(c);this.rubix.marginLeft(a);this.rubix.resetFocus()};Rubix.ColumnSeries.prototype.hidden=function(){this.chart_hidden=!0};
Rubix.ColumnSeries.prototype.show=function(){for(this.chart_hidden=!1;1<this.temp_stack.length;){var a=this.temp_stack.shift();"addPoint"===a.type?this.addPoint(a.data,a.shift,!0):this.removePoint(a.ref)}this.temp_stack.length&&(a=this.temp_stack.shift(),"addPoint"===a.type?this.addPoint(a.data,a.shift,!0):this.removePoint(a.ref))};Rubix.ColumnSeries.prototype.globalRedraw=function(a){};Rubix.ColumnSeries.prototype.forceRedraw=function(a){this.redraw(a)};
Rubix.ColumnSeries.prototype.on_complete_draw=function(){if(this.setup){var a=this;if(void 0!==this.opts.marker&&this.show_markers){this.markers=this.rubix.symbols;this.markers.selectAll(".column-symbols").remove();var c=this.markers.selectAll(".column-symbols").data(this.layers,function(a){return a.key}),b=c.enter().append("g");b.attr("class","column-symbols");switch(this.opts.marker){case "circle":case "cross":case "square":case "diamond":case "triangle-up":case "triangle-down":b=b.selectAll("path").data(function(a){for(var b=
0;b<a.values.length;b++)a.values[b].marker=a.marker,a.values[b].color=a.color;return a.values}).enter().append("path");b.attr("d",function(a){var b=d3.svg.symbol();b.type(a.marker);return b()}).attr("fill",function(a){return a.color}).style("display",function(b){return"expand"===a.rubix.column_offset?0===b.y_new&&1===b.y0?"none":null:null===b.y_new?"none":null}).attr("stroke","white");this.rubix.opts.invertAxes?b.attr("transform",function(b,c,f){c=b.y0+b.y_new;isNaN(c)&&(c=0);c=a.rubix.x(c);a.grouped&&
(c=a.rubix.x(b.y_new));var g=a.rubix.y(b.x)+a.rubix.y.rangeBand()/2;a.grouped&&(g=a.rubix.y(b.x)+a.rubix.y.rangeBand()/a.layers.length*f+a.rubix.y.rangeBand()/(2*a.layers.length));return"translate("+c+","+g+")"}):b.attr("transform",function(b,c,f){c=b.y0+b.y_new;isNaN(c)&&(c=0);c=a.rubix.y(c);a.grouped&&(c=a.rubix.y(b.y_new));var g=a.rubix.x(b.x)+a.rubix.x.rangeBand()/2;a.grouped&&(g=a.rubix.x(b.x)+a.rubix.x.rangeBand()/a.layers.length*f+a.rubix.x.rangeBand()/(2*a.layers.length));return"translate("+
g+","+c+")"});c.exit().remove();break;default:throw Error("Unknown marker type : "+this.opts.marker);}}}};
Rubix.ColumnSeries.prototype.setupFocus=function(){if(this.setup)switch(this.focus&&this.focus.remove(),this.focus=this.rubix.focus_group.append("g"),this.focus.attr("class","focus"),this.focus.style("display","none"),this.opts.marker){case "circle":case "cross":case "square":case "diamond":case "triangle-up":case "triangle-down":var a=d3.svg.symbol();a.type(this.opts.marker);this.focus.append("path").attr("d",a).attr("fill",this.opts.color).attr("stroke","white").attr("stroke-width",2);break;default:throw Error("Unknown marker type : "+
this.opts.marker);}};Rubix.ColumnSeries.prototype.on_focus=function(a,c){if(this.setup){this.off_focus();if(this.rubix.opts.invertAxes){c=c.toString().replace(".","\\.");var b=this.cb_series.selectAll(".column-"+c)}else a=a.toString().replace(".","\\."),b=this.cb_series.selectAll(".column-"+a);b.classed("filled",!0);b.attr("fill-opacity",1);b.attr("stroke-width",0)}};
Rubix.ColumnSeries.prototype.off_focus=function(){if(this.setup){var a=this.cb_series.selectAll(".filled");a.classed("filled",!1);a.attr("fill-opacity",1);a.attr("stroke-width",0)}};window.Rubix=window.Rubix||{};
Rubix.LineSeries=function(a,c){this.opts=c;this.opts.color=this.opts.color||"steelblue";this.opts.marker=this.opts.marker||"circle";this.opts.scatter=this.opts.scatter||!1;this.show_markers=this.opts.show_markers;if(!this.opts.hasOwnProperty("name"))throw Error("LineSeries should have a 'name' property");this.name=this.opts.name;this.chart_hidden=!1;this.temp_stack=[];this.setup=!1;this._setup(a)};
Rubix.LineSeries.prototype._setup=function(a){this.rubix=a;this.root=this.rubix.root;this.data=this.rubix.data;this.width=this.rubix.width;this.height=this.rubix.height;this.line_series=this.rubix.root_line_series;this.show_markers=void 0===this.show_markers?this.rubix.show_markers:this.show_markers;if(this.master_detail=this.rubix.master_detail)this.md_root=this.rubix.md_root;this.id||(this.id=this.rubix.uid("line"));var c=this;this.line=d3.svg.line();this.line.defined(function(a){return null!==
a.x&&null!==a.y});this.line.x(function(a){return c.rubix.opts.invertAxes?c.rubix.x(a.y):"column"===c.rubix.axis.x.range||"bar"===c.rubix.axis.x.range?c.rubix.x(a.x)+c.rubix.x.rangeBand()/2:c.rubix.x(a.x)});this.line.y(function(a){return c.rubix.opts.invertAxes?"column"===c.rubix.axis.y.range||"bar"===c.rubix.axis.y.range?c.rubix.y(a.x)+c.rubix.y.rangeBand()/2:c.rubix.y(a.x):c.rubix.y(a.y)});this.line.interpolate(this.rubix.interpolate);this.master_detail&&(this.master_line=d3.svg.line(),this.master_line.defined(function(a){return null!==
a.x&&null!==a.y}),this.master_line.x(function(a){return c.rubix.opts.invertAxes?c.rubix.x2(a.y):c.rubix.x2(a.x)}),this.master_line.y(function(a){return c.rubix.opts.invertAxes?c.rubix.y2(a.x):c.rubix.y2(a.y)}),this.master_line.interpolate(this.rubix.interpolate))};Rubix.LineSeries.prototype.redraw=function(a){this._setup(a);this.draw()};Rubix.LineSeries.prototype.noRedraw=function(a){this._setup(a);this.draw(!0)};
Rubix.LineSeries.prototype.addData=function(a){if(!(a instanceof Array))if(a instanceof Object){if(!a.hasOwnProperty("x")&&!a.hasOwnProperty("y"))throw Error("Object must be in the form: {x: ..., y: ...}");a=[a]}else throw Error("Data must be an array or object");a.length&&(a.sort(function(a,b){return a.x>b.x?1:a.x===b.x?0:-1}),this.data[this.name]=a,this.rubix.resetAxis(!1),this.rubix.forceRedraw(),this._animate_draw())};
Rubix.LineSeries.prototype.draw=function(a){if(this.name&&this.data&&this.data.hasOwnProperty(this.name)&&this.data[this.name].length){var c=this;if(this.line_series.selectAll("."+this.id)[0].length)this.rubix.runCommand("globalRedraw");else{this.line_series.selectAll("."+this.id+".clipped").remove();this.opts.scatter||(this.strokePath1=this.line_series.append("path").attr("class",this.id+" line").datum(this.data[this.name]).attr("d",this.line).attr("stroke","black").attr("fill","none").attr("stroke-linecap",
"round").attr("stroke-width",5).attr("stroke-opacity",.05000000000000001).attr("transform","translate(1,1)"),this.strokePath2=this.line_series.append("path").attr("class",this.id+" line").datum(this.data[this.name]).attr("d",this.line).attr("stroke","black").attr("fill","none").attr("stroke-linecap","round").attr("stroke-width",3).attr("stroke-opacity",.1).attr("transform","translate(1,1)"),this.strokePath3=this.line_series.append("path").attr("class",this.id+" line").datum(this.data[this.name]).attr("d",
this.line).attr("stroke","black").attr("fill","none").attr("stroke-linecap","round").attr("stroke-width",1).attr("stroke-opacity",.15000000000000002).attr("transform","translate(1,1)"),this.linePath=this.line_series.append("path").datum(this.data[this.name]).attr("class",this.id+" line").attr("stroke",this.opts.color).attr("fill","none").attr("stroke-linecap","round").attr("d",this.line).attr("stroke-width",2));if(this.master_detail){if(this.opts.scatter){this.md_root.select(".md-layers").attr("clip-path",
"url(#"+c.rubix.master_id+"-clip)");var c=this,b=this.data[this.name];this.markers_master=this.md_root.select(".md-layers").selectAll("."+this.id+"-marker");switch(this.opts.marker){case "circle":case "cross":case "square":case "diamond":case "triangle-up":case "triangle-down":var d=d3.svg.symbol();d.type(this.opts.marker);b=this.markers_master.data(b);b.enter().append("path").attr("d",d).attr("class",this.id+"-marker").attr("fill",this.opts.color).style("display",function(a){return null===a.y?"none":
null}).attr("stroke","none").attr("transform",function(a){var b=a.y;isNaN(b)&&(b=0);if(c.rubix.opts.invertAxes){var d=c.rubix.y(a.x);a=c.rubix.x(b);if("column"===c.rubix.axis.y.range||"bar"===c.rubix.axis.y.range)d+=c.rubix.y.rangeBand()/2}else if(d=c.rubix.y2(b),a=c.rubix.x2(a.x),"column"===c.rubix.axis.x.range||"bar"===c.rubix.axis.x.range)a+=c.rubix.x.rangeBand()/2;return"translate("+a+","+d+")"});b.exit().remove();break;default:throw Error("Unknown marker type : "+this.opts.marker);}}else this.md_root.select(".md-layers").selectAll("."+
this.id+".clipped").remove(),this.masterLinePath=this.md_root.select(".md-layers").append("path").datum(this.data[this.name]).attr("class",this.id+" line").attr("stroke",this.opts.color).attr("fill","none").attr("stroke-linecap","round").attr("d",this.master_line).attr("stroke-width",2),this.masterLinePath.attr("clip-path","url(#"+c.rubix.master_id+"-clip)"),this.masterLinePath.classed("clipped",!0);this.dataChanged&&(this.rubix.resetExtent(),this.dataChanged=!1);this.opts.scatter||(this.strokePath1.attr("clip-path",
"url(#"+c.rubix.master_id+"-clip)"),this.strokePath2.attr("clip-path","url(#"+c.rubix.master_id+"-clip)"),this.strokePath3.attr("clip-path","url(#"+c.rubix.master_id+"-clip)"),this.linePath.attr("clip-path","url(#"+c.rubix.master_id+"-clip)"),this.strokePath1.classed("clipped",!0),this.strokePath2.classed("clipped",!0),this.strokePath3.classed("clipped",!0),this.linePath.classed("clipped",!0))}this.setup=!0}this.rubix.resetFocus(a)}};
Rubix.LineSeries.prototype.update=function(a){if(!(a instanceof Array))if(a instanceof Object){if(!a.hasOwnProperty("x")&&!a.hasOwnProperty("y"))throw Error("Object must be in the form: {x: ..., y: ...}");a=[a]}else throw Error("Data must be an array or object");a.sort(function(a,b){return a.x>b.x?1:a.x===b.x?0:-1});this.data[this.name]=a;this.setup?this._animate_draw():(this.rubix.resetAxis(!1),this.rubix.forceRedraw())};Rubix.LineSeries.prototype.updatePoint=function(a,c,b){this.addPoint(a,c,b)};
Rubix.LineSeries.prototype.removePoint=function(a,c){if(this.chart_hidden)this.temp_stack.push({type:"removePoint",ref:a});else{this.data[this.name]||(this.data[this.name]=[]);for(var b=0;b<this.data[this.name].length;b++)if(this.data[this.name][b].x===a){this.data[this.name].splice(b,1);break}this.master_detail&&(this.dataChanged=!0);c||(this.setup?this._animate_draw():(this.rubix.resetAxis(!0),this.rubix.forceRedraw()))}};
Rubix.LineSeries.prototype.addPoint=function(a,c,b){if(!(a instanceof Object)||a instanceof Array)throw Error("Object required for addPoint");if(!a.hasOwnProperty("x")&&!a.hasOwnProperty("y"))throw Error("Object must be in the form: {x: ..., y: ...}");if(this.chart_hidden)this.temp_stack.push({type:"addPoint",data:a,shift:c});else{this.data[this.name]||(this.data[this.name]=[]);for(var d=!1,e=0;e<this.data[this.name].length;e++)if(this.data[this.name][e].x===a.x){this.data[this.name][e].y=a.y;d=!0;
break}d||this.data[this.name].push(a);this.data[this.name].sort(function(a,b){return a.x>b.x?1:a.x===b.x?0:-1});this.rubix.opts.interval?this.rubix.opts.interval<this.data[this.name].length&&this.data[this.name].shift():c&&this.data[this.name].shift();this.master_detail&&(this.dataChanged=!0);b||(this.setup?this._animate_draw():(this.rubix.resetAxis(!0),this.rubix.forceRedraw()))}};
Rubix.LineSeries.prototype._animate_draw=function(){for(var a=this.root.selectAll(".y.axis").selectAll("text")[0],c=[],b=0;b<a.length;b++)c.push(a[b].getBBox().width);d3.max(c);this.rubix.resetAxis(!0);this.rubix.runCommand("globalRedraw");a=this.root.selectAll(".y.axis").selectAll("text")[0];c=[];for(b=0;b<a.length;b++)c.push(a[b].getBBox().width);a=d3.max(c);this.rubix.marginLeft(a);this.rubix.resetFocus()};Rubix.LineSeries.prototype.hidden=function(){this.chart_hidden=!0};
Rubix.LineSeries.prototype.show=function(){for(this.chart_hidden=!1;1<this.temp_stack.length;){var a=this.temp_stack.shift();"addPoint"===a.type?this.addPoint(a.data,a.shift,!0):this.removePoint(a.ref)}this.temp_stack.length&&(a=this.temp_stack.shift(),"addPoint"===a.type?this.addPoint(a.data,a.shift,!0):this.removePoint(a.ref))};Rubix.LineSeries.prototype.globalRedraw=function(a){this.line_series.selectAll("."+this.id+".line").attr("d",this.line)};Rubix.LineSeries.prototype.forceRedraw=function(a){this.redraw(a)};
Rubix.LineSeries.prototype.on_complete_draw=function(){if(this.setup){var a=this,c=this.data[this.name];if(void 0!==this.opts.marker&&this.show_markers)switch(this.master_detail&&this.rubix.symbols.attr("clip-path","url(#"+a.rubix.master_id+"-clip-symbols)"),this.markers=this.rubix.symbols.selectAll("."+this.id+"-marker"),this.opts.marker){case "circle":case "cross":case "square":case "diamond":case "triangle-up":case "triangle-down":var b=d3.svg.symbol();b.type(this.opts.marker);c=this.markers.data(c);
c.enter().append("path").attr("d",b).attr("class",this.id+"-marker").attr("fill",this.opts.color).style("display",function(a){return null===a.y?"none":null}).attr("stroke","white").attr("transform",function(b){var c=b.y;isNaN(c)&&(c=0);if(a.rubix.opts.invertAxes){var f=a.rubix.y(b.x);b=a.rubix.x(c);if("column"===a.rubix.axis.y.range||"bar"===a.rubix.axis.y.range)f+=a.rubix.y.rangeBand()/2}else if(f=a.rubix.y(c),b=a.rubix.x(b.x),"column"===a.rubix.axis.x.range||"bar"===a.rubix.axis.x.range)b+=a.rubix.x.rangeBand()/
2;return"translate("+b+","+f+")"});c.exit().remove();break;default:throw Error("Unknown marker type : "+this.opts.marker);}}};
Rubix.LineSeries.prototype.setupFocus=function(){if(this.setup)switch(this.focus&&this.focus.remove(),this.focus=this.rubix.focus_group.append("g"),this.focus.attr("class","focus"),this.focus.style("display","none"),this.opts.marker){case "circle":case "cross":case "square":case "diamond":case "triangle-up":case "triangle-down":var a=d3.svg.symbol();a.type(this.opts.marker);this.focus.append("path").attr("d",a).attr("fill",this.opts.color).attr("stroke","white").attr("stroke-width",2);break;default:throw Error("Unknown marker type : "+
this.opts.marker);}};Rubix.LineSeries.prototype.on_focus=function(){this.setup&&this.linePath.attr("stroke-width",3)};Rubix.LineSeries.prototype.off_focus=function(){this.setup&&this.linePath.attr("stroke-width",2)};window.Rubix=window.Rubix||{};var slugify=function(a){a=a.replace(/[^-a-zA-Z0-9,&\s]+/ig,"");a=a.replace(/-/gi,"_");return a=a.replace(/\s/gi,"-")};Rubix.Pie=function(a,c){return new Rubix.PieDonut(a,"pie",c)};Rubix.Donut=function(a,c){return new Rubix.PieDonut(a,"donut",c)};
Rubix.PieDonut=function(a,c,b){b=b||{};this.type=c;this.is_touch_device="ontouchstart"in document.documentElement;this.legend_hidden={};this.chart_counter=0;this.master_id=this.uid("master_id");this.area_stack_data_stack=[];this.column_stack_data_stack=[];this.root_elem=$(a);this.root_elem.css("position","relative");this.root_elem.addClass("rubix-main-chart");this.root_elem.append('<div class="rubix-tooltip"></div>');this.root_elem.append('<div class="rubix-title"></div>');this.root_elem.append('<div class="rubix-subtitle"></div>');
this.root_elem.append('<div class="rubix-chart"></div>');this.root_elem.append('<div class="rubix-legend"></div>');a=b.height||150;this.root_elem.width(b.width||"100%").height(a);this.elem=this.root_elem.find(".rubix-chart");b.tooltip=b.tooltip||{};this.tooltip=this.root_elem.find(".rubix-tooltip");this.tooltip.hide();this.tooltip.html("");this.tooltip.css({"font-family":'Lato, "Lucida Grande", Arial, Helvetica, sans-serif',"font-size":"12px",position:"absolute",background:"white",color:"#89949B",
padding:"10px","padding-top":"5px","padding-bottom":"5px","max-width":150,"min-width":100,border:"2px solid #"+(b.tooltip.color?b.tooltip.color:"ccc"),"pointer-events":"none",opacity:.95,"border-radius":"5px","box-shadow":"0px 2px 2px rgba(0,0,0,0.1)","z-index":100,"user-select":"none",cursor:"default"});b.legend=b.legend||{};this.legend=this.root_elem.find(".rubix-legend");this.legend.css({"font-family":"'Lucida Grande', Arial, Helvetica, sans-serif","text-align":"center","margin-top":b.legend.top||
"-10px","margin-bottom":b.legend.bottom||"5px","user-select":"none",display:b.hideLegend?"none":"block"});this.title=this.root_elem.find(".rubix-title");this.subtitle=this.root_elem.find(".rubix-subtitle");this.title.css({"font-family":"'Lucida Grande', Arial, Helvetica, sans-serif","text-align":"center","user-select":"none","font-weight":"bold","font-size":"16px",color:"steelblue","margin-top":"10px",cursor:"default"});this.subtitle.css({"font-family":"'Lucida Grande', Arial, Helvetica, sans-serif",
"text-align":"center","user-select":"none","font-size":"10px",color:"steelblue","margin-top":"10px",cursor:"default",opacity:.8});this.elem.css({width:"100%",height:parseInt(this.root_elem.get(0).style.height),"user-select":"none",overflow:"hidden",cursor:"default"});this.root_elem.css("height","100%");this.opts=b||{};this.data=[];this.is_touch_device="ontouchstart"in document.documentElement;this.d3_eventSource=function(){for(var a=d3.event,b;b=a.sourceEvent;)a=b;return a};this.setup()};
Rubix.PieDonut.prototype.setup=function(){this._setupOpts();this._setupOnce();this._setupRedraw();this.draw()};
Rubix.PieDonut.prototype._setupOpts=function(){this.opts.margin=this.opts.margin||{};this.margin={top:this.opts.margin.top||30,left:this.opts.margin.left||30,right:this.opts.margin.right||30,bottom:this.opts.margin.bottom||30};this.opts.tooltip=this.opts.tooltip||{};this.opts.tooltip.format=this.opts.tooltip.format||{};this.tooltipFormatter={format:{x:this.opts.tooltip.format.x||"",y:this.opts.tooltip.format.y||""}};this.resize=this.opts.resize||"throttled";this.opts.title=this.opts.title||"";this.opts.subtitle=
this.opts.subtitle||"";this.title.html(this.opts.title);this.subtitle.html(this.opts.subtitle);(this.opts.title.length||this.opts.subtitle.length)&&this.elem.css("margin-top","-20px");this.opts.title.length?this.title.show():this.title.hide();this.opts.subtitle.length?this.subtitle.show():this.subtitle.hide()};Rubix.PieDonut.prototype._setupOnce=function(){};
Rubix.PieDonut.prototype._setupRedraw=function(){var a=this;$(window).on("orientationchange",function(){a.draw()});switch(this.resize){case "always":$(window).data("resize","resize");$(window).resize(function(){a.draw()});break;case "debounced":$(window).data("resize","debouncedresize");$(window).on("debouncedresize",function(){a.draw()});break;case "throttled":$(window).data("resize","throttledresize");$(window).on("throttledresize",function(){a.draw()});break;default:throw Error("Unknown resize type!");
}};Rubix.PieDonut.prototype.draw=function(){this._draw($(window).width(),$(window).height())};Rubix.PieDonut.prototype._draw=function(a,c){this._cleanElement();this._setSize();this._setupCanvas();this._setupRoot();this._setupSeries();this.final_draw()};Rubix.PieDonut.prototype._cleanElement=function(){this.elem.children().remove()};
Rubix.PieDonut.prototype._setSize=function(){this.outerWidth=this.elem.width();this.outerHeight=this.elem.height();this.width=this.outerWidth-this.margin.left-this.margin.right;this.height=this.outerHeight-this.margin.top-this.margin.bottom;this.innerRadius=0;this.outerRadius=.5*Math.min(this.width,this.height)-10;"donut"===this.type&&(this.innerRadius=.6*this.outerRadius)};
Rubix.PieDonut.prototype._setupCanvas=function(){this.canvas=d3.select(this.elem.get(0)).append("svg");this.canvas.attr("width",this.outerWidth);this.canvas.attr("height",this.outerHeight);this.canvas.append("desc").text("Powered by Rubix")};
Rubix.PieDonut.prototype._setupRoot=function(){this.root=this.canvas.append("g");this.root.attr("width",this.width);this.root.attr("height",this.height);this.root.attr("transform","translate("+this.margin.left+","+this.margin.top+")");this.hasData?this.canvas.select(".noData").style("display","none"):this.canvas.append("text").attr("class","noData").attr("font-size","30px").attr("text-anchor","middle").attr("transform","translate("+this.outerWidth/2+","+this.outerHeight/2+")").attr("font-family",
'Lato, "Lucida Grande", Arial, Helvetica, sans-serif').text("No Data")};Rubix.PieDonut.prototype._setupSeries=function(){this.root_piedonut_series=this.root.append("g").attr("class","piedonut_series").attr("transform","translate("+this.width/2+","+this.height/2+")")};Rubix.PieDonut.prototype.uid=function(a){return"rubix-pie-donut-"+a+"-"+Math.floor(2147483648*Math.random()).toString(36)};
Rubix.PieDonut.prototype.addData=function(a){a.forEach(function(a){a.value=+a.value});this.data=a;this._setupLegend();this.final_draw("launch")};
Rubix.PieDonut.prototype._setupLegend=function(){var a=this;this.legend.children().remove();for(var c=0;c<this.data.length;c++)this.legend.append("<div class='"+this.master_id+"-legend-labels' data-name='"+this.data[c].name+"' style='cursor: pointer; display: inline-block; font-weight: bold; margin-right: 10px; color: "+this.data[c].color+"'><span style='font-size: 22px;'>\u25a0 </span><span style='font-size: 12px; position:relative; top: -3px; left: -2px;'>"+this.data[c].name+"</span></div>");$("."+
this.master_id+"-legend-labels").css({opacity:.9});for(var b in this.legend_hidden)$("[data-name="+this.legend_hidden[b]+"]").css({opacity:.2}).addClass("toggle");$("."+this.master_id+"-legend-labels").off().on({hover:function(a){if(!$(this).hasClass("toggle"))switch(a.type){case "mouseenter":$(this).css({opacity:1});break;case "mouseleave":$(this).css({opacity:.9})}},click:function(b){b=$(this).hasClass("toggle");var c=$(this).attr("data-name"),f="#"+a.master_id+"-"+slugify(c);b?($(this).css({opacity:1}),
$(this).removeClass("toggle"),$(f).fadeIn(),delete a.legend_hidden[f]):($(this).css({opacity:.2}),$(this).addClass("toggle"),$(f).fadeOut(),a.legend_hidden[f]=c)}})};
Rubix.PieDonut.prototype.final_draw=function(a){var c=this;this.data.length&&this.canvas.select(".noData").style("display","none");var b=d3.svg.arc();b.innerRadius(this.innerRadius);b.outerRadius(this.outerRadius);var d=d3.layout.pie();d.sort(null);d.value(function(a){return a.value});var e=this.root_piedonut_series.selectAll(".arc").data(d(this.data),function(a){return a.data.name}),f=e.enter().append("g").attr("class","arc").style("position","relative");d3.scale.category20();var g=f.attr("id",function(a){return c.master_id+
"-"+slugify(a.data.name)}).style("fill",function(a,b){return a.data.color}).style("stroke","white").append("path").attr("d",function(a){return b({startAngle:0,endAngle:0})});"launch"===a?(this.old_pie_data=d(this.data),g.transition().attrTween("d",function(a){var c=d3.interpolate({startAngle:0,endAngle:0},{startAngle:a.startAngle,endAngle:a.endAngle});return function(a){return b(c(a))}}).duration(500)):"add"===a?e.transition().duration(500).each("end",function(){c.old_pie_data=d(c.data)}).select("path").attrTween("d",
function(a,d){var e=0,f=0;try{e=c.old_pie_data[d].startAngle,f=c.old_pie_data[d].endAngle}catch(g){e=c.old_pie_data[c.old_pie_data.length-1].startAngle,f=c.old_pie_data[c.old_pie_data.length-1].endAngle}var h=d3.interpolate({startAngle:e,endAngle:f},{startAngle:a.startAngle,endAngle:a.endAngle});a.data.hasOwnProperty("_remove")&&c.data.splice(d,1);c._setupLegend();return function(a){return b(h(a))}}):(this.old_pie_data=d(this.data),g.attr("d",function(a){return b(a)}));a="mouseover";var g="mousemove",
h="mouseout";this.is_touch_device&&(g=a="touchstart",h="touchend");var n;f.on(a,function(a){clearTimeout(n);var d=b.centroid(a),e=Math.sqrt(Math.pow(d[0],2)+Math.pow(d[1],2));a=d[0]/e*4;d=d[1]/e*4;c.is_touch_device||d3.select(this).transition().duration(150).attr("transform","translate("+[a,d]+")")});f.on(g,function(a,b){clearTimeout(n);var d=c.is_touch_device?d3.touches(this,c.d3_eventSource().changedTouches)[0]:d3.mouse(this);c.tooltip.show();c.tooltip.css({left:c.width/2-c.margin.left/2+d[0],top:c.height/
2-c.margin.top/2+d[1]});c.tooltip.html("<div style='color: "+a.data.color+";'><b><span style='font-size: 22px;'>\u25a0 </span><span style='position:relative; top: -3px; left: -2px;'>"+a.data.name+" :</span></b> <span style='position:relative; top: -3px; left: -2px;'>"+a.data.value+"</span></div>");d=d3.rgb(a.data.color);d3.select(this).style("fill",d.brighter(.5).toString())});f.on(h,function(a,b){var d=this;c.is_touch_device?(n=setTimeout(function(){c.tooltip.hide()},3E3),setTimeout(function(){d3.select(d).style("fill",
a.data.color)},3E3)):(c.tooltip.hide(),d3.select(d).style("fill",a.data.color),d3.select(d).transition().duration(150).attr("transform","translate(0, 0)"))});e.exit().remove();for(var k in this.legend_hidden)$(k).hide()};Rubix.PieDonut.prototype.removePoint=function(a){for(var c=!1,b=0;b<this.data.length;b++)if(this.data[b].name===a){c=!0;this.data[b].value=0;this.data[b]._remove=!0;break}c&&this.final_draw("add")};Rubix.PieDonut.prototype.updatePoint=function(a){this.addPoint(a)};
Rubix.PieDonut.prototype.addPoint=function(a){for(var c=!1,b=0;b<this.data.length;b++)if(this.data[b].name===a.name){c=!0;this.data[b].value=+a.value;break}c||this.data.push(a);this.final_draw("add")};window.Rubix=window.Rubix||{};
Rubix.StackedAreaSeries=function(a,c){this.opts=c;this.opts.color=this.opts.color||"steelblue";this.opts.marker=this.opts.marker||"circle";this.show_markers=this.opts.show_markers;if(!this.opts.hasOwnProperty("name"))throw Error("StackedAreaSeries should have a 'name' property");this.name=this.opts.name;this.chart_hidden=!1;this.temp_stack=[];this.setup=!1;this.last_stack=[];this.last_stack_name="";this.last_stack_added=!1;this._setup(a)};
Rubix.StackedAreaSeries.prototype._setup=function(a){this.rubix=a;this.root=this.rubix.root;this.data=this.rubix.data;this.width=this.rubix.width;this.height=this.rubix.height;this.stack=this.rubix.area_stack;this.offset=this.rubix.area_offset;this.area_stack_data=this.rubix.area_stack_data;this.stacked_area_series=this.rubix.root_stacked_area_series;this.show_markers=void 0===this.show_markers?this.rubix.show_markers:this.show_markers;if(this.master_detail=this.rubix.master_detail)this.md_root=this.rubix.md_root;
this.id||(this.id=this.rubix.uid("stacked-area"));var c=this;this.line=d3.svg.line();this.line.defined(function(a){return"expand"===c.rubix.offset?0===a.y_new&&1===a.y0?!1:!0:null!==a.y_new&&null!==a.x});this.rubix.opts.invertAxes?(this.line.x(function(a){a=a.y0+a.y_new;return isNaN(a)?0:c.rubix.x(a)}),this.line.y(function(a){return"column"===c.rubix.axis.y.range||"bar"===c.rubix.axis.y.range?c.rubix.y(a.x)+c.rubix.y.rangeBand()/2:c.rubix.y(a.x)})):(this.line.x(function(a){return"column"===c.rubix.axis.x.range||
"bar"===c.rubix.axis.x.range?c.rubix.x(a.x)+c.rubix.x.rangeBand()/2:c.rubix.x(a.x)}),this.line.y(function(a){a=a.y0+a.y_new;return isNaN(a)?0:c.rubix.y(a)}));this.line.interpolate(this.rubix.interpolate);this.area=d3.svg.area();this.area.defined(this.line.defined());this.rubix.opts.invertAxes?(this.area.x0(function(a){a=a.y0;return isNaN(a)?0:c.rubix.x(a)}),this.area.x1(function(a){a=a.y0+a.y_new;return isNaN(a)?0:c.rubix.x(a)}),this.area.y(function(a){return"column"===c.rubix.axis.y.range||"bar"===
c.rubix.axis.y.range?c.rubix.y(a.x)+c.rubix.y.rangeBand()/2:c.rubix.y(a.x)})):(this.area.x(function(a){return"column"===c.rubix.axis.x.range||"bar"===c.rubix.axis.x.range?c.rubix.x(a.x)+c.rubix.x.rangeBand()/2:c.rubix.x(a.x)}),this.area.y0(function(a){a=a.y0;return isNaN(a)?0:c.rubix.y(a)}),this.area.y1(function(a){a=a.y0+a.y_new;return isNaN(a)?0:c.rubix.y(a)}));this.area.interpolate(this.rubix.interpolate);this.master_detail&&(this.master_line=d3.svg.line(),this.master_line.defined(function(a){return"expand"===
c.rubix.area_offset?0===a.y_new&&1===a.y0?!1:!0:null!==a.y_new&&null!==a.x}),this.master_line.x(function(a){return c.rubix.x2(a.x)}),this.master_line.y(function(a){a=a.y0+a.y_new;return isNaN(a)?0:c.rubix.y2(a)}),this.master_line.interpolate(this.rubix.interpolate),this.master_area=d3.svg.area(),this.master_area.defined(this.master_line.defined()),this.master_area.x(function(a){return c.rubix.x2(a.x)}),this.master_area.y0(function(a){a=a.y0;return isNaN(a)?0:c.rubix.y2(a)}),this.master_area.y1(function(a){a=
a.y0+a.y_new;return isNaN(a)?0:c.rubix.y2(a)}),this.master_area.interpolate(this.rubix.interpolate))};Rubix.StackedAreaSeries.prototype.redraw=function(a){this._setup(a);this.draw()};Rubix.StackedAreaSeries.prototype.noRedraw=function(a){this._setup(a);this.draw(!0)};
Rubix.StackedAreaSeries.prototype.addData=function(a){if(!(a instanceof Array))if(a instanceof Object){if(!a.hasOwnProperty("x")&&!a.hasOwnProperty("y"))throw Error("Object must be in the form: {x: ..., y: ...}");a=[a]}else throw Error("Data must be an array or object");a.length&&(a.sort(function(a,b){return a.x>b.x?1:a.x===b.x?0:-1}),this.data[this.name]=a,this.area_stack_data.push({key:this.name,color:this.opts.color,values:this.data[this.name],orderKey:this.area_stack_data.length}),this.rubix.resetAxis(!0),
this.rubix.forceRedraw(),this._animate_draw())};
Rubix.StackedAreaSeries.prototype.draw=function(a){if(this.name&&this.data&&this.data.hasOwnProperty(this.name)&&this.data[this.name].length){var c=this.layers;try{this.layers=this.stack(this.area_stack_data)}catch(b){this.layers=c}var d=this;if(this.stacked_area_series.selectAll("."+this.id)[0].length)this.rubix.runCommand("globalRedraw");else{try{this.stacked_area_series.selectAll(".layer").remove();this.stacked_area_series.selectAll("."+this.id+"-line").remove();var e=this.stacked_area_series.selectAll(".layer").data(this.layers,
function(a){return a.key}),f=e.enter().append("path");f.attr("class","layer").attr("d",function(a){return d.area(a.values)}).attr("fill",function(a){return a.color}).attr("fill-opacity",.5).attr("stroke","none");e.exit().remove();if(this.master_detail&&(f.attr("clip-path","url(#"+d.rubix.master_id+"-clip)"),f.classed("clipped",!0),!a)){var g=this.md_root.select(".md-layers").selectAll(".layer").data(this.layers,function(a){return a.key}),h=g.enter().append("path");h.attr("class","layer").attr("d",
function(a){return d.master_area(a.values)}).attr("fill",function(a){return a.color}).attr("fill-opacity",.5).attr("stroke","none");h.attr("clip-path","url(#"+d.rubix.master_id+"-clip)");h.classed("clipped",!0);g.exit().remove()}for(c=0;c<this.layers.length;c++)if(this.name===this.layers[c].key){var n=this.layers[c].values;this.strokePath1=this.stacked_area_series.append("path").attr("class",this.id+"-line").datum(n).attr("d",this.line).attr("stroke","black").attr("fill","none").attr("stroke-linecap",
"round").attr("stroke-width",5).attr("stroke-opacity",.05000000000000001).attr("transform","translate(1,1)");this.strokePath2=this.stacked_area_series.append("path").attr("class",this.id+"-line").datum(n).attr("d",this.line).attr("stroke","black").attr("fill","none").attr("stroke-linecap","round").attr("stroke-width",3).attr("stroke-opacity",.1).attr("transform","translate(1,1)");this.strokePath3=this.stacked_area_series.append("path").attr("class",this.id+"-line").datum(n).attr("d",this.line).attr("stroke",
"black").attr("fill","none").attr("stroke-linecap","round").attr("stroke-width",1).attr("stroke-opacity",.15000000000000002).attr("transform","translate(1,1)");this.linePath=this.stacked_area_series.append("path").datum(n).attr("class",this.id+"-line").attr("stroke",this.opts.color).attr("fill","none").attr("stroke-linecap","round").attr("d",this.line).attr("stroke-width",2);this.master_detail&&(a||(this.md_root.select(".md-layers").selectAll("."+this.id+"-line").remove(),this.masterLinePath=this.md_root.select(".md-layers").append("path").datum(n).attr("class",
this.id+"-line").attr("stroke",this.opts.color).attr("fill","none").attr("stroke-linecap","round").attr("d",this.master_line).attr("stroke-width",2),this.masterLinePath.attr("clip-path","url(#"+d.rubix.master_id+"-clip)"),this.masterLinePath.classed("clipped",!0),this.dataChanged&&(this.rubix.resetExtent(),this.dataChanged=!1)),this.strokePath1.attr("clip-path","url(#"+d.rubix.master_id+"-clip)"),this.strokePath2.attr("clip-path","url(#"+d.rubix.master_id+"-clip)"),this.strokePath3.attr("clip-path",
"url(#"+d.rubix.master_id+"-clip)"),this.linePath.attr("clip-path","url(#"+d.rubix.master_id+"-clip)"),this.strokePath1.classed("clipped",!0),this.strokePath2.classed("clipped",!0),this.strokePath3.classed("clipped",!0),this.linePath.classed("clipped",!0));break}}catch(k){}this.setup=!0}this.rubix.resetFocus(a)}};Rubix.StackedAreaSeries.prototype.updatePoint=function(a,c,b){this.addPoint(a,c,b)};
Rubix.StackedAreaSeries.prototype.removePoint=function(a,c){if(this.chart_hidden)this.temp_stack.push({type:"removePoint",ref:a});else{this.data[this.name]||(this.data[this.name]=[]);for(var b=!1,d=0,e=0;e<this.data[this.name].length;e++)if(this.data[this.name][e].x===a){this.data[this.name][e].y=null;d=e;b=!0;break}if(b){b=!1;for(e=0;e<this.area_stack_data.length;e++){var f=this.area_stack_data[e];try{if(f.values[d].x===a&&null!==f.values[d].y){b=!0;break}}catch(g){}}if(!b)for(e=0;e<this.area_stack_data.length;e++)this.area_stack_data[e].values.splice(d,
1);d=this.layers;try{this.layers=this.stack(this.area_stack_data)}catch(h){this.layers=d}this.master_detail&&(this.dataChanged=!0);c||(this.setup?this._animate_draw():(this.rubix.resetAxis(!0),this.rubix.forceRedraw()))}}};
Rubix.StackedAreaSeries.prototype.addPoint=function(a,c,b){if(!(a instanceof Object)||a instanceof Array)throw Error("Object required for addPoint");if(!a.hasOwnProperty("x")&&!a.hasOwnProperty("y"))throw Error("Object must be in the form: {x: ..., y: ...}");if(this.chart_hidden)this.temp_stack.push({type:"addPoint",data:a,shift:c});else{this.data[this.name]||(this.data[this.name]=[]);for(var d=!1,e=0;e<this.data[this.name].length;e++)if(this.data[this.name][e].x===a.x){this.data[this.name][e].y=
a.y;d=!0;break}d||this.data[this.name].push(a);this.data[this.name].sort(function(a,b){return a.x>b.x?1:a.x===b.x?0:-1});this.rubix.opts.interval?this.rubix.opts.interval<this.data[this.name].length&&this.data[this.name].shift():c&&this.data[this.name].shift();c=d3.max(this.area_stack_data,function(a){return a.values.length});for(e=0;e<this.area_stack_data.length;e++)d=this.area_stack_data[e],d.values.length<c&&d.values.push({x:a.x,y:null});a=this.layers;try{this.layers=this.stack(this.area_stack_data)}catch(f){this.layers=
a}this.master_detail&&(this.dataChanged=!0);b||(this.setup?this._animate_draw():(this.rubix.resetAxis(!0),this.rubix.forceRedraw()))}};
Rubix.StackedAreaSeries.prototype._animate_draw=function(){for(var a=this.root.selectAll(".y.axis").selectAll("text")[0],c=[],b=0;b<a.length;b++)c.push(a[b].getBBox().width);d3.max(c);this.rubix.resetAxis(!0);this.rubix.runCommand("globalRedraw");a=this.root.selectAll(".y.axis").selectAll("text")[0];c=[];for(b=0;b<a.length;b++)c.push(a[b].getBBox().width);a=d3.max(c);this.rubix.marginLeft(a);this.rubix.resetFocus()};Rubix.StackedAreaSeries.prototype.hidden=function(){this.chart_hidden=!0};
Rubix.StackedAreaSeries.prototype.show=function(){for(this.chart_hidden=!1;1<this.temp_stack.length;){var a=this.temp_stack.shift();"addPoint"===a.type?this.addPoint(a.data,a.shift,!0):this.removePoint(a.ref)}this.temp_stack.length&&(a=this.temp_stack.shift(),"addPoint"===a.type?this.addPoint(a.data,a.shift,!0):this.removePoint(a.ref))};Rubix.StackedAreaSeries.prototype.globalRedraw=function(a){this.stacked_area_series.select("."+this.id+"-line").attr("d",this.line)};
Rubix.StackedAreaSeries.prototype.forceRedraw=function(a){this.redraw(a)};
Rubix.StackedAreaSeries.prototype.on_complete_draw=function(){if(this.setup){var a=this;if(void 0!==this.opts.marker&&this.show_markers)switch(this.master_detail&&this.rubix.symbols.attr("clip-path","url(#"+a.rubix.master_id+"-clip-symbols)"),this.markers=this.rubix.symbols.selectAll("."+this.id+"-marker"),this.opts.marker){case "circle":case "cross":case "square":case "diamond":case "triangle-up":case "triangle-down":var c=d3.svg.symbol();c.type(this.opts.marker);var b=this.markers.data(this.data[this.name]);
b.enter().append("path").attr("d",c).attr("class",this.id+"-marker").attr("fill",this.opts.color).style("display",function(b){return"expand"===a.rubix.area_offset?0===b.y_new&&1===b.y0?"none":null:null===b.y_new?"none":null}).attr("stroke","white").attr("transform",function(b){var c=b.y0+b.y_new;isNaN(c)&&(c=0);if(a.rubix.opts.invertAxes){var f=a.rubix.y(b.x);b=a.rubix.x(c);if("column"===a.rubix.axis.y.range||"bar"===a.rubix.axis.y.range)f+=a.rubix.y.rangeBand()/2}else if(f=a.rubix.y(c),b=a.rubix.x(b.x),
"column"===a.rubix.axis.x.range||"bar"===a.rubix.axis.x.range)b+=a.rubix.x.rangeBand()/2;return"translate("+b+","+f+")"});b.exit().remove();break;default:throw Error("Unknown marker type : "+this.opts.marker);}}};
Rubix.StackedAreaSeries.prototype.setupFocus=function(){if(this.setup)switch(this.focus&&this.focus.remove(),this.focus=this.rubix.focus_group.append("g"),this.focus.attr("class","focus"),this.focus.style("display","none"),this.opts.marker){case "circle":case "cross":case "square":case "diamond":case "triangle-up":case "triangle-down":var a=d3.svg.symbol();a.type(this.opts.marker);this.focus.append("path").attr("d",a).attr("fill",this.opts.color).attr("stroke","white").attr("stroke-width",2);break;
default:throw Error("Unknown marker type : "+this.opts.marker);}};Rubix.StackedAreaSeries.prototype.on_focus=function(){this.setup&&this.linePath.attr("stroke-width",3)};Rubix.StackedAreaSeries.prototype.off_focus=function(){this.setup&&this.linePath.attr("stroke-width",2)};